/*
============================================================
VectorSearchService.java ì „ì²´ ìš©ë„
============================================================
- OpenAPI ë¬¸ì„œë¥¼ íŒŒì‹±í•˜ì—¬ API ì—”ë“œí¬ì¸íŠ¸ë¥¼ "ë¬¸ì„œ ê°ì²´(Document)"ë¡œ ë³€í™˜í•˜ê³ 
 Cosine Similarity ê¸°ë°˜ ê²€ìƒ‰(Keywords â†’ API ìë™ ë§¤í•‘)ì„ ìˆ˜í–‰í•˜ëŠ” í•µì‹¬ ê²€ìƒ‰ ì—”ì§„.
- ê¸°ëŠ¥ ìš”ì•½:
 1) OpenAPI JSON â†’ Document ë¦¬ìŠ¤íŠ¸(ì—”ë“œí¬ì¸íŠ¸ ë‹¨ìœ„)ë¡œ ì¸ë±ì‹±
 2) ê° Documentë¥¼ Bag-of-Words ê¸°ë°˜ ë²¡í„°ë¡œ ë³€í™˜
 3) Cosine Similarity ë¡œ ê²€ìƒ‰ ì§ˆì˜(query)ì™€ ë¬¸ì„œ(Document)ë¥¼ ë¹„êµ
 4) ìµœì†Œ ìœ ì‚¬ë„ ê¸°ì¤€(MIN_SIMILARITY)ì— ë”°ë¼ API í›„ë³´ í•„í„°ë§
 5) ê°€ì¥ ìœ ì‚¬í•œ API ì—”ë“œí¬ì¸íŠ¸ top-K ë°˜í™˜
- Spring AI ê¸°ë°˜ ì±—ë´‡ì´ "ì´ APIì˜ ê¸°ëŠ¥ ì•Œë ¤ì¤˜", "ë¡œê·¸ì¸ API ì–´ë”¨ì–´?" ê°™ì€ ì§ˆë¬¸ì—
 ìë™ìœ¼ë¡œ API ë¬¸ì„œë¥¼ ì°¾ì•„ì£¼ëŠ” ê²€ìƒ‰ ì—”ì§„ ì—­í•  ìˆ˜í–‰.

============================================================
ê° ë¼ì¸ë³„ ìƒì„¸ ì£¼ì„
============================================================
*/

package com.example.demo.chat.support;                     // íŒ¨í‚¤ì§€ ê²½ë¡œ

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.Operation;
import io.swagger.v3.oas.models.PathItem;
import io.swagger.v3.oas.models.media.Schema;
import io.swagger.v3.oas.models.parameters.Parameter;
import io.swagger.v3.oas.models.responses.ApiResponse;
import io.swagger.v3.parser.OpenAPIV3Parser;
import io.swagger.v3.parser.core.models.ParseOptions;
import io.swagger.v3.parser.core.models.SwaggerParseResult;
import org.apache.commons.text.similarity.CosineSimilarity;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import java.util.*;
import java.util.concurrent.atomic.AtomicReference;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

@Component                                                // ìŠ¤í”„ë§ ì»´í¬ë„ŒíŠ¸ë¡œ ë“±ë¡
public class VectorSearchService {

    private static final Logger log = LoggerFactory.getLogger(VectorSearchService.class);
    // ë¡œê¹…ìš© Logger ìƒì„±

    private static final Pattern TOKEN_SPLIT = Pattern.compile("\\W+");
    // ë¹„ë¬¸ì(íŠ¹ìˆ˜ë¬¸ì) ê¸°ì¤€ìœ¼ë¡œ í† í° ë¶„ë¦¬í•˜ëŠ” ì •ê·œì‹

    private static final double MIN_SIMILARITY = 0.08;
    // ê²€ìƒ‰ ìµœì†Œ ìœ ì‚¬ë„ ê¸°ì¤€ â†’ ë„ˆë¬´ ë†’ìœ¼ë©´ ê²€ìƒ‰ ì•ˆ ë¨, ë„ˆë¬´ ë‚®ìœ¼ë©´ ë…¸ì´ì¦ˆ ì¦ê°€

    private final CosineSimilarity cosineSimilarity = new CosineSimilarity();
    // Apache commons-text ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°ê¸°

    private final AtomicReference<List<IndexedDocument>> documents = new AtomicReference<>(List.of());
    // ì¸ë±ì‹±ëœ ë¬¸ì„œë¥¼ ìŠ¤ë ˆë“œ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ëŠ” ì €ì¥ì†Œ

    public VectorSearchService(Optional<OpenAPI> openAPI) {
        // Optional<OpenAPI>ê°€ ìˆìœ¼ë©´ ì´ˆê¸° ì¸ë±ì‹± ìˆ˜í–‰
        openAPI.ifPresent(this::refresh);
    }

    public List<Document> getAllDocuments() {
        // í˜„ì¬ ì¸ë±ì‹±ëœ ëª¨ë“  ë¬¸ì„œë¥¼ Document ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜
        var docs = documents.get();
        return docs.stream()
                .map(IndexedDocument::document)
                .toList();
    }

    public List<Document> findRelatedDocuments(String query, int topK) {
        // ê²€ìƒ‰ì–´(query)ì™€ ê°€ì¥ ìœ ì‚¬í•œ top-K ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜
        var docs = documents.get();
        if (docs.isEmpty() || query == null || query.isBlank()) {
            return Collections.emptyList();  // ì¡°ê±´ ë¶ˆì¶©ì¡± ì‹œ ë¹ˆ ë¦¬ìŠ¤íŠ¸
        }

        var queryVector = toVector(query);  // ê²€ìƒ‰ì–´ ë²¡í„°í™”
        if (queryVector.isEmpty()) {
            // ê²€ìƒ‰ì–´ì—ì„œ ì˜ë¯¸ ìˆëŠ” í† í°ì´ ì—†ì„ ê²½ìš° ìƒìœ„ Kê°œ ë°˜í™˜
            return docs.stream()
                    .limit(Math.max(topK, 1))
                    .map(IndexedDocument::document)
                    .toList();
        }

        var scoredResults = docs.stream()
                // ê° ë¬¸ì„œì— ëŒ€í•´ ìœ ì‚¬ë„ ê³„ì‚°
                .map(doc -> new ScoredDocument(doc.document(), similarity(doc.vector(), queryVector)))
                // ìµœì†Œ ìœ ì‚¬ë„ í•„í„°ë§
                .filter(scored -> scored.score() >= MIN_SIMILARITY)
                // ìœ ì‚¬ë„ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                .sorted(Comparator.comparingDouble(ScoredDocument::score).reversed())
                // top-K ê°œìˆ˜ ì œí•œ
                .limit(Math.max(topK, 1))
                .toList();

        if (scoredResults.isEmpty()) {
            // ë§¤ì¹­ëœ ë¬¸ì„œ ì—†ìŒ ë¡œê·¸
            log.debug("ê²€ìƒ‰ì–´ '{}' - ìœ ì‚¬ë„ {}% ì´ìƒì¸ ë¬¸ì„œ ì—†ìŒ", query, (int)(MIN_SIMILARITY * 100));
            return Collections.emptyList();
        }

        log.debug("ê²€ìƒ‰ì–´ '{}' - {}ê°œ ë¬¸ì„œ ê²€ìƒ‰ë¨ (ìµœê³  ìœ ì‚¬ë„: {}%)",
                query, scoredResults.size(), (int)(scoredResults.get(0).score() * 100));

        // Documentë§Œ ì¶”ì¶œí•˜ì—¬ ë°˜í™˜
        return scoredResults.stream()
                .map(ScoredDocument::document)
                .toList();
    }

    public void refreshFromJson(String openApiJson) {
        // JSON ë¬¸ìì—´ì„ OpenAPI ê°ì²´ë¡œ ë³€í™˜í•œ ë’¤ ì¸ë±ì‹± ìˆ˜í–‰
        if (openApiJson == null || openApiJson.isBlank()) {
            log.warn("OpenAPI JSONì´ ë¹„ì–´ ìˆì–´ ë¬¸ì„œ ì¸ë±ì‹±ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
            return;
        }
        try {
            var options = new ParseOptions();
            options.setResolve(true);          // $ref í•´ì„
            options.setFlatten(true);         // flatten ì²˜ë¦¬
            SwaggerParseResult result = new OpenAPIV3Parser().readContents(openApiJson, null, options);

            if (result.getMessages() != null && !result.getMessages().isEmpty()) {
                log.warn("OpenAPI ë¬¸ì„œ íŒŒì‹± ê²½ê³ : {}", result.getMessages());
            }
            if (result.getOpenAPI() != null) {
                refresh(result.getOpenAPI());   // ì„±ê³µ ì‹œ ì¸ë±ì‹±
            } else {
                log.warn("OpenAPI ë¬¸ì„œë¥¼ íŒŒì‹±í–ˆì§€ë§Œ ìœ íš¨í•œ ê°ì²´ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
        } catch (Exception ex) {
            log.error("OpenAPI JSON íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", ex);
        }
    }

    public void refresh(OpenAPI openAPI) {
        // OpenAPI ê°ì²´ë¡œë¶€í„° ë¬¸ì„œë¥¼ ì¸ë±ì‹±í•˜ëŠ” ë©”ì¸ ë¡œì§
        if (openAPI == null) {
            return;
        }
        var built = buildDocuments(openAPI);      // Document ë¦¬ìŠ¤íŠ¸ ìƒì„±
        documents.set(built);                     // ì¸ë±ì‹± ì €ì¥
        log.info("OpenAPI ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ {}ê°œì˜ ì—”ë“œí¬ì¸íŠ¸ ë¬¸ì„œë¥¼ ì¸ë±ì‹±í–ˆìŠµë‹ˆë‹¤.", built.size());
    }

    private List<IndexedDocument> buildDocuments(OpenAPI openAPI) {
        // OpenAPIì˜ paths ë¥¼ ìˆœíšŒí•˜ë©° Document ë¦¬ìŠ¤íŠ¸ ìƒì„±
        if (openAPI.getPaths() == null || openAPI.getPaths().isEmpty()) {
            return List.of();
        }

        List<IndexedDocument> result = new ArrayList<>();
        openAPI.getPaths().forEach((path, pathItem) -> {
            // pathItem ë‚´ ëª¨ë“  HTTP ë©”ì„œë“œ ì²˜ë¦¬
            pathItem.readOperationsMap().forEach((method, operation) -> {
                var content = describeOperation(path, method, operation);
                if (!content.isBlank()) {
                    // ë¬¸ì„œ ê°ì²´ ìƒì„± ë° ë²¡í„° ì €ì¥
                    result.add(new IndexedDocument(
                            new Document(
                                    content,
                                    method != null ? method.name() : null,
                                    path,
                                    operation != null ? operation.getSummary() : null,
                                    operation != null ? operation.getDescription() : null),
                            toVector(content)));
                }
            });
        });
        return result;
    }

    private String describeOperation(String path, PathItem.HttpMethod method, Operation operation) {
        // API í•œ ê°œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬ì¡°ì ì¸ í…ìŠ¤íŠ¸ ì„¤ëª…ìœ¼ë¡œ ìƒì„±
        var builder = new StringBuilder();
        builder.append("[").append(method.name()).append("] ").append(path).append('\n');

        var pathKeywords = extractPathKeywords(path);  // /auth/login â†’ auth login
        if (!pathKeywords.isEmpty()) {
            builder.append("í‚¤ì›Œë“œ: ").append(pathKeywords).append('\n');
        }

        if (operation.getSummary() != null) {
            builder.append("ìš”ì•½: ").append(operation.getSummary()).append('\n');
        }
        if (operation.getDescription() != null) {
            builder.append("ì„¤ëª…: ").append(operation.getDescription()).append('\n');
        }

        // ìš”ì²­ íŒŒë¼ë¯¸í„°
        if (operation.getParameters() != null && !operation.getParameters().isEmpty()) {
            builder.append("ìš”ì²­ íŒŒë¼ë¯¸í„°:\n");
            for (Parameter parameter : operation.getParameters()) {
                builder.append(" - ")
                        .append(parameter.getName())
                        .append(" (in: ").append(parameter.getIn()).append(')');
                if (Boolean.TRUE.equals(parameter.getRequired())) {
                    builder.append(" [required]");
                }
                if (parameter.getDescription() != null) {
                    builder.append(" : ").append(parameter.getDescription());
                }
                builder.append('\n');
            }
        }

        // ìš”ì²­ ë³¸ë¬¸ ë‚´ìš©
        if (operation.getRequestBody() != null && operation.getRequestBody().getDescription() != null) {
            builder.append("ìš”ì²­ ë³¸ë¬¸: ").append(operation.getRequestBody().getDescription()).append('\n');
        }

        if (operation.getRequestBody() != null && operation.getRequestBody().getContent() != null) {
            var mediaTypes = operation.getRequestBody().getContent().keySet();
            if (!mediaTypes.isEmpty()) {
                builder.append("ìš”ì²­ Content-Type: ").append(String.join(", ", mediaTypes)).append('\n');
            }
        }

        // ì‘ë‹µ ì½”ë“œ
        if (operation.getResponses() != null && !operation.getResponses().isEmpty()) {
            builder.append("ì‘ë‹µ ì½”ë“œ:\n");
            for (Map.Entry<String, ApiResponse> entry : operation.getResponses().entrySet()) {
                builder.append(" - ").append(entry.getKey());
                var apiResponse = entry.getValue();
                if (apiResponse.getDescription() != null) {
                    builder.append(" : ").append(apiResponse.getDescription());
                }
                builder.append('\n');
            }
        }

        // íƒœê·¸
        var tags = operation.getTags();
        if (tags != null && !tags.isEmpty()) {
            builder.append("íƒœê·¸: ").append(String.join(", ", tags)).append('\n');
        }

        // ì‘ë‹µ ìŠ¤í‚¤ë§ˆ íŒŒì‹±
        var responses = operation.getResponses();
        if (responses != null) {
            var schemas = responses.values().stream()
                    .map(ApiResponse::getContent)
                    .filter(Objects::nonNull)
                    .flatMap(content -> content.values().stream())
                    .map(media -> media.getSchema())
                    .filter(Objects::nonNull)
                    .map(this::describeSchema)
                    .filter(Optional::isPresent)
                    .map(Optional::get)
                    .collect(Collectors.toSet());

            if (!schemas.isEmpty()) {
                builder.append("ì‘ë‹µ ìŠ¤í‚¤ë§ˆ: ").append(String.join(" | ", schemas)).append('\n');
            }
        }

        return builder.toString().trim();
    }

    private Optional<String> describeSchema(Schema<?> schema) {
        // ìŠ¤í‚¤ë§ˆì˜ íƒ€ì… í˜¹ì€ $refë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        if (schema == null) {
            return Optional.empty();
        }
        var type = schema.getType();
        var ref = schema.get$ref();
        if (ref != null) {
            return Optional.of("ref=" + ref);
        }
        if (type != null) {
            return Optional.of("type=" + type);
        }
        return Optional.empty();
    }

    private String extractPathKeywords(String path) {
        // API pathì—ì„œ ì˜ë¯¸ ìˆëŠ” ì„¸ê·¸ë¨¼íŠ¸ë§Œ ì¶”ì¶œ (auth, login ë“±)
        if (path == null || path.isBlank()) {
            return "";
        }
        var segments = new ArrayList<String>();
        for (var segment : path.split("/")) {
            if (segment.isBlank() || segment.equals("api") || segment.equals("v1") ||
                    segment.equals("demo") || segment.startsWith("{")) {
                continue;
            }
            segments.add(segment);
        }
        return String.join(" ", segments);
    }

    private Map<CharSequence, Integer> toVector(String text) {
        // í…ìŠ¤íŠ¸ë¥¼ ë‹¨ì–´ë³„ Bag-of-Words ë²¡í„°ë¡œ ë³€í™˜
        if (text == null || text.isBlank()) {
            return Map.of();
        }
        var vector = new HashMap<CharSequence, Integer>();
        for (String token : TOKEN_SPLIT.split(text.toLowerCase(Locale.ROOT))) {
            if (token.isBlank() || token.length() < 2) {
                continue; // ë„ˆë¬´ ì§§ì€ ë‹¨ì–´ í•„í„°ë§
            }
            vector.merge(token, 1, Integer::sum); // ë‹¨ì–´ ë¹ˆë„ìˆ˜ ì¦ê°€
        }
        return vector;
    }

    private double similarity(Map<CharSequence, Integer> left, Map<CharSequence, Integer> right) {
        // ë‘ ë²¡í„°ì˜ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°
        if (left.isEmpty() || right.isEmpty()) {
            return 0.0;
        }
        return cosineSimilarity.cosineSimilarity(left, right);
    }

    // ë¬¸ì„œ ë°ì´í„° êµ¬ì¡°: í…ìŠ¤íŠ¸ + ë©”íƒ€ì •ë³´
    public record Document(String content, String httpMethod, String path, String summary, String description) {}

    // ì¸ë±ì‹±ëœ ë¬¸ì„œ(ë¬¸ì„œ + ë²¡í„°)
    private record IndexedDocument(Document document, Map<CharSequence, Integer> vector) {}

    // ìœ ì‚¬ë„ ê³„ì‚° ê²°ê³¼(ë¬¸ì„œ + ì ìˆ˜)
    private record ScoredDocument(Document document, double score) {}
}
/*
============================================================
UserChatController.java íŒŒì¼ ì „ì²´ ìš©ë„
============================================================
- ìŠ¤í”„ë§ AI ê¸°ë°˜ ì‚¬ìš©ììš© ì±—ë´‡ REST ì»¨íŠ¸ë¡¤ëŸ¬.
- ì‚¬ìš©ì ì¹œí™”ì ì¸ ì‘ë‹µ ìŠ¤íƒ€ì¼ê³¼ ë§í¬ ì²˜ë¦¬ ê·œì¹™ì´ ì‹œìŠ¤í…œ ë©”ì‹œì§€ì— ì •ì˜ë¨.
- ê¸°ìˆ  ìš©ì–´ ë° ë§í¬/ê²½ë¡œ í‘œí˜„ì„ ê¸ˆì§€í•˜ê³ , í˜ì´ì§€ ì´ë™ ë§í¬ëŠ” JSON í•„ë“œë¡œ ë³„ë„ ì œê³µ.
============================================================
*/
package com.example.demo.chat;

import org.springframework.ai.chat.model.ChatModel;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.ai.chat.messages.SystemMessage;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.security.core.Authentication;

import java.util.Map;

@RestController
@RequestMapping("/api/v1/chat/user")
public class UserChatController {

    private final ChatModel chatModel;
    private final ChatSessionService sessionService;

    public UserChatController(ChatModel chatModel, ChatSessionService sessionService) {
        this.chatModel = chatModel;
        this.sessionService = sessionService;
    }

    private String detectPageLink(String userMessage) {
        String msg = userMessage.toLowerCase();

        if (msg.contains("ëŒ€íšŒ") || msg.contains("competition") || msg.contains("ì°¸ì—¬")) {return "/competitions";}
        if (msg.contains("ë¬¸ì˜") || msg.contains("ì§ˆë¬¸") || msg.contains("help")) {return "/inquiry/write";}
        if (msg.contains("ë¦¬ë”ë³´ë“œ") || msg.contains("leaderboard") || msg.contains("ìˆœìœ„")) {return "/leaderboard";}
        if (msg.contains("ì„¤ì •") || msg.contains("ë¹„ë°€ë²ˆí˜¸") || msg.contains("ê³„ì •") || msg.contains("íƒˆí‡´") || 
                msg.contains("ê³„ì • ì‚­ì œ") || msg.contains("ì´ë©”ì¼ ìˆ˜ì •")) {return "/setting";}
        if (msg.contains("í”„ë¡œí•„") || msg.contains("ë‚´ ì •ë³´") || msg.contains("ë§ˆì´í˜ì´ì§€")) {return "/myprofile";}

        return null;
    }

    @PostMapping
    public ResponseEntity<Map<String, Object>> chat(@RequestBody UserChatRequest request, Authentication authentication) {

        String userid = authentication.getName();
        String raw = request.sessionId();
        String sessionId = userid + "_" + (raw == null || raw.isBlank() ? java.util.UUID.randomUUID() : raw);
        String question = request.message();

        // ì´ì „ ëŒ€í™” íˆìŠ¤í† ë¦¬ ë¡œë“œ
        var history = sessionService.getHistory(sessionId);

        // ì‚¬ìš©ììš© í”„ë¡¬í”„íŠ¸ (ê¸°ìˆ  ìš©ì–´ ê¸ˆì§€)
        var systemMessage = new SystemMessage("""
            ë‹¹ì‹ ì€ 'Hangle ì„œë¹„ìŠ¤ ê³ ê°ì§€ì› ì±—ë´‡'ì…ë‹ˆë‹¤.
            
            ### ë‹µë³€ ìŠ¤íƒ€ì¼ ê·œì¹™
            - ë‹µë³€ì€ ë”°ëœ»í•˜ê³  ì¹œì ˆí•œ ë§íˆ¬ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
            - ë‹µë³€ì€ í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ì§€ ë§ê³  2~3ë¬¸ì¥ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ êµ¬ì„±í•©ë‹ˆë‹¤.
              - 1ë¬¸ì¥: ì‚¬ìš©ìê°€ ê¶ê¸ˆí•œ ê¸°ëŠ¥ì„ ì„¤ëª…í•©ë‹ˆë‹¤.
              - 2ë¬¸ì¥: ì‚¬ìš©ìê°€ ì°¸ê³ í•  ìˆ˜ ìˆëŠ” ë¶€ê°€ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
              - 3ë¬¸ì¥: "ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ìš©í•´ë³´ì„¸ìš”!"ì™€ ê°™ì´ ë²„íŠ¼ í´ë¦­ì„ ìœ ë„í•©ë‹ˆë‹¤.
            - ë‹µë³€ì€ ë°˜ë“œì‹œ ë‘ ë¬¸ì¥ì´ ëë‚œ ë’¤ ì¤„ë°”ê¿ˆ(ë¹ˆ ì¤„ 1ì¹¸)ì„ ë„£ê³ , ë§ˆì§€ë§‰ 3ë²ˆì§¸ ë¬¸ì¥ì„ ì‘ì„±í•©ë‹ˆë‹¤.
            - ë‹µë³€ í…ìŠ¤íŠ¸ì—ëŠ” ë§í¬ë‚˜ ë§í¬ì²˜ëŸ¼ ë³´ì´ëŠ” í‘œí˜„ì„ ì ˆëŒ€ í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            
            ### ë§í¬ ê´€ë ¨ ê¸ˆì§€ ê·œì¹™ (ë§¤ìš° ì¤‘ìš”)
            - ì–´ë– í•œ í˜•íƒœë¡œë“  í…ìŠ¤íŠ¸ ë‚´ì— ë§í¬ êµ¬ì¡°ë¥¼ ë„£ì§€ ë§ˆì‹­ì‹œì˜¤.
            - ì•„ë˜ ëª¨ë“  í˜•íƒœ ê¸ˆì§€:
              - Markdown ë§í¬: [í…ìŠ¤íŠ¸](ë§í¬)
              - í…ìŠ¤íŠ¸ë§Œ ìˆëŠ” ëŒ€ê´„í˜¸: [í…ìŠ¤íŠ¸]
              - ë¯¸ì™„ì„± Markdown: [í…ìŠ¤íŠ¸](
              - ê´„í˜¸ë¡œ ê°ì‹¼ í…ìŠ¤íŠ¸: (í…ìŠ¤íŠ¸)
              - URL, ë„ë©”ì¸, ê²½ë¡œ(/something), ìˆ«ìë¡œ ì‹œì‘í•˜ëŠ” ê²½ë¡œ ë“± ë§í¬ë¡œ ë³´ì´ëŠ” ëª¨ë“  í‘œí˜„
            - â€œì´ê³³ì—ì„œ í´ë¦­â€, â€œì—¬ê¸°ë¥¼ ëˆ„ë¥´ë©´â€ì²˜ëŸ¼ ë§í¬ í´ë¦­ì„ ì•”ì‹œí•˜ëŠ” í‘œí˜„ë„ ê¸ˆì§€í•©ë‹ˆë‹¤.
            - ë‹µë³€ í…ìŠ¤íŠ¸ì—ëŠ” ë§í¬ ëŒ€ì‹  ìì—°ì–´ë§Œ ì‘ì„±í•˜ê³ , ì‹¤ì œ ë§í¬ëŠ” ì˜¤ì§ ì‘ë‹µ JSONì˜ link í•„ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì œê³µí•©ë‹ˆë‹¤.
            - ê´„í˜¸ë¡œ ê°ì‹¼ í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            - ë‹µë³€ í…ìŠ¤íŠ¸ì—ì„œëŠ” ê´„í˜¸( ) ìì²´ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            - ë¬¸ì¥ ì•ˆì—ì„œ ê´„í˜¸ë¥¼ í™œìš©í•œ êµ¬ì¡°ë¥¼ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.
            
            ### ë§í¬ ì•ˆë‚´ ë°©ì‹
            - íŠ¹ì • í˜ì´ì§€ ì•ˆë‚´ ì‹œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤:
              - "ì•„ë˜ ë²„íŠ¼ì„ ì´ìš©í•˜ì—¬ ì´ë™í•´ë³´ì„¸ìš” â†“"
              - "ì•„ë˜ ë°”ë¡œê°€ê¸° ë²„íŠ¼ì„ í†µí•´ ì‰½ê²Œ ì´ë™í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”! ğŸ˜Š"
            - ë¬¸ì¥ ì•ˆì—ì„œ ë§í¬ë¥¼ ì•”ì‹œí•˜ê±°ë‚˜ ë§í¬ì²˜ëŸ¼ ë³´ì´ëŠ” ë‹¨ì–´ë¥¼ ìƒì„±í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
            
            ### ê¸ˆì§€ì‚¬í•­
            - ê¸°ìˆ  ìš©ì–´(API, HTTP, Swagger, JSON ë“±) ê¸ˆì§€
            - ì‹œìŠ¤í…œ ë‚´ë¶€ ë™ì‘Â·ì²˜ë¦¬ ê³¼ì • ì„¤ëª… ê¸ˆì§€
            - ë‹µë³€ í…ìŠ¤íŠ¸ ì•ˆì— URL, ê²½ë¡œ, JSON êµ¬ì¡°, ë§í¬ í‰ë‚´ í‘œí˜„ ëª¨ë‘ ê¸ˆì§€
            
            í•­ìƒ í•œêµ­ì–´ë¡œ ë‹µë³€í•©ë‹ˆë‹¤.
        """);

        // ì‚¬ìš©ì ì§ˆë¬¸ ë©”ì‹œì§€
        var userMessage = new UserMessage("ì‚¬ìš©ì ì§ˆë¬¸: \"" + question + "\"");

        // í”„ë¡¬í”„íŠ¸ êµ¬ì„±: System + ì´ì „ íˆìŠ¤í† ë¦¬ + í˜„ì¬ ì§ˆë¬¸
        var promptMessages = new java.util.ArrayList<org.springframework.ai.chat.messages.Message>();
        promptMessages.add(systemMessage);
        promptMessages.addAll(history);  // ì´ì „ user/assistant ë©”ì‹œì§€ë“¤
        promptMessages.add(userMessage);

        var response = chatModel.call(new Prompt(promptMessages));
        String reply = response.getResult().getOutput().getText();

        // ê³¼ë„í•œ ì¤„ë°”ê¿ˆ ì œê±°
        reply = reply.replaceAll("\\n{3,}", "\n\n");
        reply = reply.replaceAll("https?://\\S+", "");
        reply = reply.replaceAll("www\\.[a-zA-Z0-9./_-]+", "");
        reply = reply.replaceAll("[a-zA-Z0-9._%+-]+\\.(com|net|io|kr|co)\\S*", "");

        // í˜¹ì‹œë¼ë„ ê¸°ìˆ  ë‹¨ì–´ê°€ í¬í•¨ë˜ë©´ ì œê±°(ì´ì¤‘ ë³´í˜¸)
        String[] bannedWords = { "API", "Swagger", "ì—”ë“œí¬ì¸íŠ¸", "HTTP", "JSON", "í”„ë¡ íŠ¸ì—”ë“œ", "ë°±ì—”ë“œ" };
        for (String word : bannedWords) { reply = reply.replace(word, ""); }

        // ê¸¸ì´ ì œí•œ (í•„ìš”ì‹œ)
        if (reply.length() > 500) {reply = reply.substring(0, 480) + "... (ê°„ë‹¨íˆ ì•ˆë‚´í•´ë“œë ¸ìŠµë‹ˆë‹¤)";}

        // ì„¸ì…˜ íˆìŠ¤í† ë¦¬ ì €ì¥
        sessionService.appendUserMessage(sessionId, question);
        sessionService.appendAssistantMessage(sessionId, reply);
        String detectedLink = detectPageLink(question);

        return ResponseEntity.ok(Map.of(
                "sessionId", sessionId,
                "reply", reply,
                "link", detectedLink
        ));
    }

    public record UserChatRequest(String sessionId, String message) {}
}
/*
============================================================
OpenApiDocumentLoader.java íŒŒì¼ ì „ì²´ ìš©ë„
============================================================
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì§í›„(OpenAPI ìµœì´ˆ ë¡œë”©)ì™€ ì¼ì • ì£¼ê¸°ë§ˆë‹¤(Scheduler)
  OpenAPI ë¬¸ì„œë¥¼ ì„œë²„ì—ì„œ ê°€ì ¸ì™€(JSON) ë²¡í„° ê²€ìƒ‰ìš© ë°ì´í„°ë¡œ ì¬êµ¬ì„±í•˜ëŠ” ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” ì»´í¬ë„ŒíŠ¸.
- VectorSearchService ë¥¼ í†µí•´ OpenAPI ìŠ¤í™ì„ ë²¡í„°í™”í•˜ì—¬
  'Spring AI ê¸°ë°˜ ì±—ë´‡'ì´ API ê´€ë ¨ ì§ˆë¬¸ì„ ì´í•´í•˜ê³  ë‹µë³€í•˜ë„ë¡ ì§€ì›í•˜ëŠ” í•µì‹¬ ë¡œë” ì—­í• .

============================================================
ê° ë¼ì¸ë³„ ìƒì„¸ ì£¼ì„ ë²„ì „
============================================================
*/

package com.example.demo.chat.support;                 // íŒ¨í‚¤ì§€ ì„ ì–¸: support í•˜ìœ„ ê¸°ëŠ¥ ëª¨ë“ˆ

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.ApplicationListener;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

@Component                                              // ìŠ¤í”„ë§ ë¹ˆ ë“±ë¡ â†’ ìë™ íƒì§€ ë° ì‚¬ìš© ê°€ëŠ¥
public class OpenApiDocumentLoader implements ApplicationListener<ApplicationReadyEvent> { // ì• í”Œë¦¬ì¼€ì´ì…˜ ê¸°ë™ ì´ë²¤íŠ¸ ê°ì§€

    private static final Logger log = LoggerFactory.getLogger(OpenApiDocumentLoader.class);
    // í˜„ì¬ í´ë˜ìŠ¤ìš© Logger ìƒì„±

    private final RestTemplate restTemplate = new RestTemplate();
    // REST API ìš”ì²­ì„ ë³´ë‚´ê¸° ìœ„í•œ RestTemplate ì¸ìŠ¤í„´ìŠ¤ ìƒì„±

    private final VectorSearchService vectorSearchService;
    // OpenAPI ë¬¸ì„œë¥¼ ë²¡í„° DBìš© ë°ì´í„°ë¡œ ë³€í™˜í•˜ëŠ” ì„œë¹„ìŠ¤

    private final String openApiUrl;
    // OpenAPI JSON ë¬¸ì„œë¥¼ ê°€ì ¸ì˜¬ URLì„ ì €ì¥í•  ë³€ìˆ˜

    // ìƒì„±ì: VectorSearchService ì£¼ì… + openApiUrl ê°’ì„ application.properties ì—ì„œ ì½ì–´ì˜´
    public OpenApiDocumentLoader(VectorSearchService vectorSearchService,
                                 @Value("${chatbot.open-api-url:http://localhost:${server.port:8080}/v3/api-docs}") String openApiUrl) {
        this.vectorSearchService = vectorSearchService;  // ë²¡í„° ê²€ìƒ‰ ì„œë¹„ìŠ¤ ì£¼ì…
        this.openApiUrl = openApiUrl;                    // í”„ë¡œí¼í‹°ì—ì„œ ì½ì€ URL ì €ì¥
    }

    @Override
    public void onApplicationEvent(ApplicationReadyEvent event) {
        // ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì™„ì „íˆ ê¸°ë™ë˜ì—ˆì„ ë•Œ ìë™ ì‹¤í–‰
        loadOpenApi();  // ìµœì´ˆ OpenAPI ë¬¸ì„œ ë¡œë”©
    }

    // ìŠ¤ì¼€ì¤„ëŸ¬: ìµœì´ˆ ì§€ì—°(initialDelayString) í›„ ì§€ì • ì£¼ê¸°(fixedDelayString)ë§ˆë‹¤ ì‹¤í–‰
    @Scheduled(initialDelayString = "${chatbot.open-api-refresh-initial-delay:PT5M}",
            fixedDelayString = "${chatbot.open-api-refresh-interval:PT30M}")
    public void scheduledReload() {
        loadOpenApi();  // ì£¼ê¸°ì ìœ¼ë¡œ OpenAPI ë¬¸ì„œ ë‹¤ì‹œ ë¡œë“œ
    }

    private void loadOpenApi() {
        // OpenAPI ë¬¸ì„œë¥¼ ê°€ì ¸ì™€ ë²¡í„° ê²€ìƒ‰ ì„œë¹„ìŠ¤ì— ë°˜ì˜í•˜ëŠ” í•µì‹¬ ë©”ì„œë“œ
        try {
            log.info("OpenAPI ë¬¸ì„œë¥¼ {}ì—ì„œ ë¡œë“œí•©ë‹ˆë‹¤.", openApiUrl);
            // ë¡œë”© ì‹œì‘ ë¡œê·¸ ì¶œë ¥

            var response = restTemplate.getForObject(openApiUrl, String.class);
            // REST GET ìš”ì²­ìœ¼ë¡œ OpenAPI JSON ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°

            vectorSearchService.refreshFromJson(response);
            // ê°€ì ¸ì˜¨ JSON ë¬¸ì„œë¥¼ ë²¡í„° ê²€ìƒ‰ ì‹œìŠ¤í…œì— ë°˜ì˜(íŒŒì‹± + ë²¡í„°í™”)

            log.info("OpenAPI ë¬¸ì„œ ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            // ì„±ê³µ ë¡œê·¸ ì¶œë ¥
        } catch (Exception ex) {
            log.warn("OpenAPI ë¬¸ì„œë¥¼ {}ì—ì„œ ë¡œë“œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. {}", openApiUrl, ex.getMessage());
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê²½ê³  ë¡œê·¸ ì¶œë ¥
        }
    }
}
/*
============================================================
ChatSessionService.java íŒŒì¼ ì „ì²´ ìš©ë„
============================================================
- ì„¸ì…˜ë³„ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ë©”ëª¨ë¦¬ì— ë³´ê´€/ì¡°íšŒ/ê°±ì‹ /ë§Œë£Œí•˜ëŠ” ì„œë¹„ìŠ¤.
- ë‹¨ìˆœíˆ ìµœê·¼ Nê°œì˜ ë©”ì‹œì§€ë¥¼ ìœ ì§€í•˜ì—¬ LLM í˜¸ì¶œ ì‹œ ì»¨í…ìŠ¤íŠ¸ë¡œ ì‚¬ìš©.
============================================================
êµ¬ì„±ìš”ì†Œ ë° íë¦„ ê°œìš”
============================================================
- conversations: ì„¸ì…˜ID â†’ ëŒ€í™”(ë©”ì‹œì§€ ëª©ë¡, ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê°)
- ensureSessionId(): ìœ íš¨í•œ ì„¸ì…˜ID ë³´ì¥
- getHistory(): ì„¸ì…˜ íˆìŠ¤í† ë¦¬ ì¡°íšŒ ë° ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê° ê°±ì‹ 
- appendUserMessage()/appendAssistantMessage(): ë©”ì‹œì§€ ì¶”ê°€(ë‚´ë¶€ appendMessage ì‚¬ìš©)
- evictExpiredSessions(): TTL ê¸°ì¤€ ë§Œë£Œ ì„¸ì…˜ ì œê±°
============================================================
ì£¼ì˜ì‚¬í•­
============================================================
- ì„œë²„ ì¬ì‹œì‘ ì‹œ íˆìŠ¤í† ë¦¬ëŠ” ì‚¬ë¼ì§(ì¸ë©”ëª¨ë¦¬).
- ë™ì‹œì„±: ConcurrentHashMap ì‚¬ìš©, ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ëŠ” ë‹¨ìˆœ ArrayListë¡œ ìµœì†Œ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ ê°€ì •.
============================================================
*/

package com.example.demo.chat;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.ai.chat.messages.Message;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.ai.chat.messages.AssistantMessage;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.time.Instant;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

@Service
public class ChatSessionService {

    private static final Logger log = LoggerFactory.getLogger(ChatSessionService.class);

    // ì„¸ì…˜ID â†’ ëŒ€í™”(ë©”ì‹œì§€ ëª©ë¡, ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê°) ì €ì¥ì†Œ
    private final Map<String, Conversation> conversations = new ConcurrentHashMap<>();

    // ì„¸ì…˜ TTL(ë§Œë£Œ ê¸°ì¤€)
    private final Duration ttl = Duration.ofHours(3);

    // íˆìŠ¤í† ë¦¬ ìµœëŒ€ ë³´ê´€ ê°œìˆ˜ (ìµœê·¼ Nê°œë§Œ ìœ ì§€)
    // íˆìŠ¤í† ë¦¬ ì¶•ì†Œ (6 â†’ 2) - LLM ì²˜ë¦¬ ì†ë„ í–¥ìƒ ëª©ì 
    private static final int MAX_HISTORY = 2;

    /*
    ============================================================
    í•¨ìˆ˜ìš©ë„: ì„¸ì…˜IDê°€ ì—†ê±°ë‚˜ ê³µë°±ì´ë©´ ì‹ ê·œ ìƒì„±í•˜ì—¬ ë°˜í™˜
    ì…ë ¥: sessionId(ë¬¸ìì—´ ë˜ëŠ” null)
    ì¶œë ¥: ìœ íš¨í•œ ì„¸ì…˜ID(ë¬¸ìì—´)
    ë¹„ê³ : í´ë¼ì´ì–¸íŠ¸ê°€ ì„¸ì…˜ì„ ìœ ì§€í•˜ì§€ ì•Šì„ ë•Œ ì‹ ê·œ ì„¸ì…˜ ë°œê¸‰
    ============================================================
    */
    public String ensureSessionId(String sessionId) {
        if (sessionId == null || sessionId.isBlank()) {
            return UUID.randomUUID().toString();
        }
        return sessionId;
    }

    /*
    ============================================================
    í•¨ìˆ˜ìš©ë„: ì„¸ì…˜ íˆìŠ¤í† ë¦¬ ì¡°íšŒ ë° ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê° ê°±ì‹ 
    ì…ë ¥: sessionId
    ì¶œë ¥: ë©”ì‹œì§€ ëª©ë¡(ë³µì‚¬ë³¸)
    ë¹„ê³ : ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ìƒì„±; ìµœëŒ€ ê°œìˆ˜ ì œí•œì€ append ë‹¨ê³„ì—ì„œ ê´€ë¦¬
    ============================================================
    */
    public List<Message> getHistory(String sessionId) {
        var conversation = conversations.computeIfAbsent(sessionId, id -> new Conversation(new ArrayList<>(), Instant.now()));
        conversation.touch();
        log.debug("ì„¸ì…˜ [{}] íˆìŠ¤í† ë¦¬ ë¡œë“œ (ë©”ì‹œì§€ {}ê±´)", sessionId, conversation.messages().size());
        return new ArrayList<>(conversation.messages());
    }

    /*
    ============================================================
    í•¨ìˆ˜ìš©ë„: ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    ì…ë ¥: sessionId, content
    ì¶œë ¥: ì—†ìŒ
    ë¹„ê³ : ë‚´ë¶€ì ìœ¼ë¡œ appendMessage ì‚¬ìš©
    ============================================================
    */
    public void appendUserMessage(String sessionId, String content) {
        appendMessage(sessionId, new UserMessage(content));
        log.info("ì„¸ì…˜ [{}] ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥: {}", sessionId, content);
    }

    /*
    ============================================================
    í•¨ìˆ˜ìš©ë„: ì–´ì‹œìŠ¤í„´íŠ¸(ë´‡) ë©”ì‹œì§€ ì¶”ê°€
    ì…ë ¥: sessionId, content
    ì¶œë ¥: ì—†ìŒ
    ë¹„ê³ : ë‚´ë¶€ì ìœ¼ë¡œ appendMessage ì‚¬ìš©
    ============================================================
    */
    public void appendAssistantMessage(String sessionId, String content) {
        appendMessage(sessionId, new AssistantMessage(content));
        log.info("ì„¸ì…˜ [{}] ì±—ë´‡ ì‘ë‹µ ì €ì¥: {}", sessionId, content);
    }

    /*
    ============================================================
    í•¨ìˆ˜ìš©ë„: ê³µí†µ ë©”ì‹œì§€ ì¶”ê°€ ë° íˆìŠ¤í† ë¦¬ ê°œìˆ˜ ì œí•œ ì ìš©
    ì…ë ¥: sessionId, message
    ì¶œë ¥: ì—†ìŒ
    ë¹„ê³ : MAX_HISTORY ì´ˆê³¼ ì‹œ ê°€ì¥ ì˜¤ë˜ëœ ë©”ì‹œì§€ ì œê±°
    ============================================================
    */
    private void appendMessage(String sessionId, Message message) {
        var conversation = conversations.computeIfAbsent(sessionId, id -> new Conversation(new ArrayList<>(), Instant.now()));
        conversation.messages().add(message);
        if (conversation.messages().size() > MAX_HISTORY) {
            conversation.messages().remove(0);
            log.debug("ì„¸ì…˜ [{}] íˆìŠ¤í† ë¦¬ ìµœëŒ€ {}ê±´ìœ¼ë¡œ ì ˆë‹¨", sessionId, MAX_HISTORY);
        }
        conversation.touch();
    }

    /*
    ============================================================
    í•¨ìˆ˜ìš©ë„: TTL ê¸°ì¤€ìœ¼ë¡œ ë§Œë£Œëœ ì„¸ì…˜ ì œê±°
    ì…ë ¥: ì—†ìŒ
    ì¶œë ¥: ì—†ìŒ
    ë¹„ê³ : ì£¼ê¸°ì (ìŠ¤ì¼€ì¤„ë§) í˜¸ì¶œì„ ê¶Œì¥
    ============================================================
    */
    public void evictExpiredSessions() {
        var now = Instant.now();
        conversations.entrySet().removeIf(entry -> Duration.between(entry.getValue().lastAccessed(), now).compareTo(ttl) > 0);
        log.debug("ë§Œë£Œëœ ì„¸ì…˜ ì •ë¦¬ ì™„ë£Œ. í˜„ì¬ ì„¸ì…˜ ìˆ˜: {}", conversations.size());
    }

    /*
    ============================================================
    Conversation ë‚´ë¶€ í´ë˜ìŠ¤ ìš©ë„
    ============================================================
    - ë‹¨ì¼ ì„¸ì…˜ì˜ ë©”ì‹œì§€ ëª©ë¡ê³¼ ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê°ì„ ë³´ê´€.
    - touch() í˜¸ì¶œ ì‹œì ì— ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê°ì„ ê°±ì‹ .
    ============================================================
    */
    private static final class Conversation {
        private final List<Message> messages;
        private Instant lastAccessed;

        // messages, lastAccessed ì´ˆê¸°í™”
        private Conversation(List<Message> messages, Instant lastAccessed) {
            this.messages = messages;
            this.lastAccessed = lastAccessed;
        }

        // ë©”ì‹œì§€ ëª©ë¡ ì ‘ê·¼ì
        public List<Message> messages() {
            return messages;
        }

        // ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê° ì ‘ê·¼ì
        public Instant lastAccessed() {
            return lastAccessed;
        }

        // ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê° ê°±ì‹ 
        public void touch() {
            this.lastAccessed = Instant.now();
        }
    }
}
/*
============================================================
DevChatController.java íŒŒì¼ ì „ì²´ ìš©ë„
============================================================
- LLM(ìŠ¤í”„ë§ AI)ê³¼ OpenAPI ë¬¸ì„œ ì¸ë±ìŠ¤ë¥¼ í™œìš©í•´ API ìƒë‹´ì„ ì œê³µí•˜ëŠ” REST ì»¨íŠ¸ë¡¤ëŸ¬.
- ì…ë ¥(ì‚¬ìš©ì ì§ˆë¬¸)ì„ ë°›ì•„ Swagger ë¬¸ì„œ ìš”ì•½ ì»¨í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ í”„ë¡¬í”„íŠ¸ë¥¼ êµ¬ì„±í•˜ê³ , LLM í˜¸ì¶œ í›„ ê²°ê³¼ë¥¼ ê²€ì¦/ì •ì œí•˜ì—¬ ë°˜í™˜.
- ì‘ë‹µ ë‚´ ì–¸ê¸‰ëœ ê²½ë¡œë¥¼ ì¶”ì¶œí•´ Swagger UI ë“±ìœ¼ë¡œ ì—°ê²° ê°€ëŠ¥í•œ ë§í¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
============================================================
ê° êµ¬ì„±ìš”ì†Œ ë° ì£¼ìš” ë©”ì„œë“œ ê°œìš”
============================================================
- ìƒì„±ì: ì˜ì¡´ì„±(ChatModel/ì„¸ì…˜/ë²¡í„°ê²€ìƒ‰)ê³¼ ê¸°ë³¸ baseUrl ì´ˆê¸°í™”
- chat(): ìƒë‹´ ë©”ì¸ í”Œë¡œìš°(ë¬¸ì„œí™•ì¸â†’ì»¨í…ìŠ¤íŠ¸â†’LLMí˜¸ì¶œâ†’ê²€ì¦â†’ë§í¬)
- buildSwaggerContext(): ì¸ë±ì‹±ëœ ë¬¸ì„œë“¤ì„ ì œí•œ ê¸¸ì´ ë‚´ì—ì„œ ì§§ì€ í…ìŠ¤íŠ¸ë¡œ ìš”ì•½
- removeDuplicateLines(): LLM ì‘ë‹µì—ì„œ ì¤‘ë³µ ë¼ì¸ì„ ì œê±°(ë²ˆí˜¸ í”„ë¦¬í”½ìŠ¤ ë¬´ì‹œ)
- validateResponseRelevance(): ì§ˆë¬¸ í‚¤ì›Œë“œì™€ ì‘ë‹µì˜ API ì¼ì¹˜ ì—¬ë¶€ë¥¼ ê²€ì¦
- extractKeywords(): ì§ˆë¬¸ì—ì„œ ë„ë©”ì¸ í‚¤ì›Œë“œ ì¶”ì¶œ
- extractApiPaths(): ì‘ë‹µ í…ìŠ¤íŠ¸ì—ì„œ /api/... ê²½ë¡œ ì¶”ì¶œ
- buildLinks(): ì–¸ê¸‰ëœ ë¬¸ì„œë§Œ ë§í¬ë¡œ ê°€ê³µ(ì—†ìœ¼ë©´ Swagger UI ë§í¬)
============================================================
ê° ë¼ì¸ë³„ ìƒì„¸ ì£¼ì„ì€ ê° í•¨ìˆ˜ ë¸”ë¡ ìƒë‹¨/ë‚´ë¶€ì— í¬í•¨
============================================================
*/

import com.example.demo.chat.support.VectorSearchService;
import com.example.demo.chat.support.VectorSearchService.Document;
import jakarta.validation.Valid;
import jakarta.validation.constraints.NotBlank;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.ai.chat.messages.SystemMessage;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.security.core.Authentication;

import java.util.List;

@RestController
@RequestMapping("/api/v1/chat/dev")
public class DevChatController {

    private static final Logger log = LoggerFactory.getLogger(DevChatController.class);
    private static final int MAX_CONTEXT_CHARS = 3000; // ì»¨í…ìŠ¤íŠ¸ ìµœëŒ€ ê¸¸ì´ ì œí•œ(LLM í”„ë¡¬í”„íŠ¸ í¬ê¸° ê´€ë¦¬)
    private static final List<String> DOMAIN_KEYWORDS = List.of( // ì§ˆë¬¸ í‚¤ì›Œë“œ ì¶”ì¶œìš© ë„ë©”ì¸ ì‚¬ì „
            "ìƒí’ˆ", "ì œí’ˆ", "product", "item", "goods",
            "ì£¼ë¬¸", "order", "êµ¬ë§¤", "purchase",
            "íšŒì›", "ì‚¬ìš©ì", "ìœ ì €", "user", "member",
            "íŒŒì¼", "file", "ì—…ë¡œë“œ", "upload", "ë‹¤ìš´ë¡œë“œ", "download",
            "ì¸ì¦", "auth", "ë¡œê·¸ì¸", "login", "ë¡œê·¸ì•„ì›ƒ", "logout",
            "ì¥ë°”êµ¬ë‹ˆ", "cart", "basket",
            "ê²°ì œ", "payment", "pay",
            "ë°°ì†¡", "delivery", "shipping"
    );
    private static final java.util.regex.Pattern API_CODE_PATTERN = java.util.regex.Pattern.compile("`(/api/[^`\\s]+)`"); // ë°±í‹± í¬í•¨ ê²½ë¡œ íŒ¨í„´
    private static final java.util.regex.Pattern API_PLAIN_PATTERN = java.util.regex.Pattern.compile("(?:^|\\s)(/api/[^\\s,.:;)]+)"); // ì¼ë°˜ ê²½ë¡œ íŒ¨í„´

    private final ChatModel chatModel; // ìŠ¤í”„ë§ AI LLM ëª¨ë¸
    private final ChatSessionService sessionService; // ì„¸ì…˜/íˆìŠ¤í† ë¦¬ ì„œë¹„ìŠ¤
    private final VectorSearchService vectorSearchService; // OpenAPI ì¸ë±ìŠ¤ ê²€ìƒ‰ ì„œë¹„ìŠ¤
    private final String apiBaseUrl; // Swagger UI ë“± ë§í¬ ê¸°ë°˜ URL

    /*
    ============================================================
    ìƒì„±ì ìš©ë„
    ============================================================
    - LLM ëª¨ë¸/ì„¸ì…˜/ë²¡í„°ê²€ìƒ‰ ì˜ì¡´ì„± ì£¼ì…, ê¸°ë³¸ API base URL ì •ê·œí™”
    ============================================================
    ë¼ì¸ë³„ ì£¼ì„
    - chatModel/sessionService/vectorSearchService: ì»¨íŠ¸ë¡¤ëŸ¬ í•µì‹¬ ì˜ì¡´ì„±
    - apiBaseUrl: ë§ë¯¸ ìŠ¬ë˜ì‹œ ì œê±°í•˜ì—¬ ë§í¬ ìƒì„± ì‹œ ì¤‘ë³µ "//" ë°©ì§€
    ============================================================
    */
    public DevChatController(ChatModel chatModel, ChatSessionService sessionService,
                             VectorSearchService vectorSearchService,
                             @Value("${chatbot.api-base-url:http://localhost:8080}") String apiBaseUrl) {
        this.chatModel = chatModel; // ëª¨ë¸ ë³´ê´€
        this.sessionService = sessionService; // ì„¸ì…˜ ì„œë¹„ìŠ¤ ë³´ê´€
        this.vectorSearchService = vectorSearchService; // ê²€ìƒ‰ ì„œë¹„ìŠ¤ ë³´ê´€
        this.apiBaseUrl = apiBaseUrl.endsWith("/") ? apiBaseUrl.substring(0, apiBaseUrl.length() - 1) : apiBaseUrl; // ë§ë¯¸ ìŠ¬ë˜ì‹œ ì •ë¦¬
    }

    /*
    ============================================================
    chat() ë©”ì„œë“œ ìš©ë„
    ============================================================
    - ìƒë‹´ ë©”ì¸ ì—”ë“œí¬ì¸íŠ¸: ì§ˆë¬¸ ìˆ˜ì‹  â†’ ë¬¸ì„œ í™•ì¸/ì»¨í…ìŠ¤íŠ¸ ìƒì„± â†’ LLM í˜¸ì¶œ â†’ ê²°ê³¼ ì •ì œ/ê²€ì¦ â†’ ë§í¬ ìƒì„± â†’ ì‘ë‹µ
    ============================================================
    ë¼ì¸ë³„ ì£¼ì„(í•µì‹¬)
    - sessionId ë³´ì¥ ë° ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥
    - ë¬¸ì„œ ì—†ìœ¼ë©´ í´ë°± ë©”ì‹œì§€ ë°˜í™˜
    - buildSwaggerContextë¡œ ì œí•œ ê¸¸ì´ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
    - System/User Prompt êµ¬ì„± í›„ chatModel.call
    - removeDuplicateLinesë¡œ ì‘ë‹µ ì •ì œ
    - validateResponseRelevanceë¡œ í‚¤ì›Œë“œ-API ì¼ì¹˜ í™•ì¸(ë¶ˆì¼ì¹˜ ì‹œ í´ë°±)
    - extractApiPathsë¡œ ê²½ë¡œ ì¶”ì¶œ â†’ buildLinksë¡œ ë§í¬ ë§Œë“¤ê¸°(ì—†ìœ¼ë©´ Swagger UI ë§í¬)
    ============================================================
    */
    @PostMapping
    public ResponseEntity<ChatResponse> chat(@Valid @RequestBody ChatRequest request, Authentication authentication) {
        String raw = request.sessionId();
        String userid = authentication.getName();  // â† í˜„ì¬ ë¡œê·¸ì¸ ê³„ì • êµ¬ë¶„

        String sessionId = userid + "_" +
                (raw == null || raw.isBlank() ? java.util.UUID.randomUUID() : raw); // ì„¸ì…˜ ID í™•ë³´
        log.info("=== ì„¸ì…˜ [{}] ì§ˆë¬¸ ìˆ˜ì‹ : {} ===", sessionId, request.message()); // ìˆ˜ì‹  ë¡œê·¸

        sessionService.appendUserMessage(sessionId, request.message()); // íˆìŠ¤í† ë¦¬ì— ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€

        var allDocs = vectorSearchService.getAllDocuments(); // ì¸ë±ì‹±ëœ ë¬¸ì„œ ì „ëŸ‰ ì¡°íšŒ
        log.info("ì„¸ì…˜ [{}] Swagger ë¬¸ì„œ {}ê°œ ë¡œë“œë¨", sessionId, allDocs.size()); // ë¬¸ì„œ ê°œìˆ˜ ë¡œê·¸
        if (allDocs.isEmpty()) { // ë¬¸ì„œ ì—†ìœ¼ë©´ ì¦‰ì‹œ í´ë°±
            var noApiMessage = "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ë“±ë¡ëœ API ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.";
            sessionService.appendAssistantMessage(sessionId, noApiMessage);
            return ResponseEntity.ok(new ChatResponse(sessionId, noApiMessage, List.of()));
        }

        var swaggerContext = buildSwaggerContext(allDocs); // ì»¨í…ìŠ¤íŠ¸ ìƒì„±
        log.info("ì„¸ì…˜ [{}] Swagger ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ ({}ì)", sessionId, swaggerContext.length());

        var systemMessage = new SystemMessage("""
            ë‹¹ì‹ ì€ 'Hangle API ë„ìš°ë¯¸ ì±—ë´‡'ì…ë‹ˆë‹¤.
            
            ì—­í• :
            - ì‚¬ìš©ìì˜ ì§ˆë¬¸ì´ ìì—°ì–´ë¡œ ë˜ì–´ ìˆì–´ë„ ì˜ë„ë¥¼ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ APIë¥¼ ì°¾ì•„ ì„¤ëª…í•©ë‹ˆë‹¤.
            - Swagger ë¬¸ì„œ(Available APIs)ì— ì¡´ì¬í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            - Swagger ë¬¸ì„œì— ì—†ëŠ” APIëŠ” ì ˆëŒ€ ìƒì„±í•˜ê±°ë‚˜ ì¶”ì¸¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤(í™˜ê° ê¸ˆì§€).
            - ì§ˆë¬¸ì´ ëª¨í˜¸í•´ë„ ì˜ë¯¸ë¥¼ íŒŒì•…í•˜ì—¬ ê°€ì¥ ê´€ë ¨ëœ APIë¥¼ ì œì‹œí•©ë‹ˆë‹¤.
            - ìµœëŒ€ 8ê°œì˜ ê´€ë ¨ APIë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
            - ë‹µë³€ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
            
            ì‘ì—… ë°©ì‹:
            1. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ìì—°ì–´ë¡œ í•´ì„í•˜ì—¬ í•µì‹¬ ëª©ì /ê¸°ëŠ¥/ë™ì‚¬ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
               ì˜ˆ: "ëŒ€íšŒ ë§Œë“¤ë ¤ë©´?" â†’ "ëŒ€íšŒ ìƒì„± API"
                   "ë¹„ë°€ë²ˆí˜¸ ì–´ë–»ê²Œ ë°”ê¿”?" â†’ "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ API"
            
            2. ì¶”ì¶œí•œ í‚¤ì›Œë“œë¥¼ Swagger ì—”ë“œí¬ì¸íŠ¸(summary/description)ì™€ ë¹„êµí•˜ì—¬ ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ APIë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            
            3. ê´€ë ¨ APIê°€ ì—†ìœ¼ë©´ ì•„ë˜ ë¬¸ì¥ì„ ì •í™•íˆ ì¶œë ¥í•©ë‹ˆë‹¤.
               "ì£„ì†¡í•©ë‹ˆë‹¤. í•´ë‹¹ ë‚´ìš©ì„ Swagger ë¬¸ì„œì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            
            4. APIë¥¼ ë‚˜ì—´í•  ë•ŒëŠ” ë‹¤ìŒ í˜•ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:
               METHOD /path - Summary
               (ê°€ëŠ¥í•˜ë©´ 1ì¤„ ì„¤ëª…ë„ ì¶”ê°€)
            
            5. ì¤‘ë³µëœ APIëŠ” ì ˆëŒ€ ì¶œë ¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            6. Swagger ë¬¸ì„œì— ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ë¡œ/ë©”ì„œë“œëŠ” ì ˆëŒ€ ì–¸ê¸‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            7. ì‘ë‹µì€ ê¹”ë”í•˜ê³  ê°„ê²°í•˜ê²Œ êµ¬ì„±í•©ë‹ˆë‹¤.
            
            ì¶œë ¥ í˜•ì‹ ì˜ˆì‹œ:
            GET /api/user/me - ë‚´ ì •ë³´ ì¡°íšŒ
            Explanation: ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
            
            DELETE /api/inquiry/{id} - ë¬¸ì˜ ì‚­ì œ
            Explanation: ë³¸ì¸ì´ ì‘ì„±í•œ ë¬¸ì˜ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            """);

        var userPrompt = String.format("""
            ì•„ë˜ëŠ” í˜„ì¬ ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  Swagger ê¸°ë°˜ API ëª©ë¡ì…ë‹ˆë‹¤.
            
            [Available APIs]
            %s
            
            
            [ì‚¬ìš©ì ì§ˆë¬¸]
            "%s"
            
            
            ë‹¹ì‹ ì˜ ì‘ì—… ì§€ì¹¨:
            
            1. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ìì—°ì–´ë¡œ ë¶„ì„í•˜ì—¬ í•µì‹¬ ì˜ë„(ì˜ˆ: ë¡œê·¸ì¸, ì¡°íšŒ, ìƒì„±, ìˆ˜ì •, ì‚­ì œ ë“±)ë¥¼ íŒŒì•…í•˜ì„¸ìš”.
            2. ì˜ë„ì™€ ê°€ì¥ ê´€ë ¨ëœ Swagger APIë“¤ì„ ì°¾ì•„ ë‚˜ì—´í•˜ì„¸ìš”.
            3. Swagger ë¬¸ì„œì— ì¡´ì¬í•˜ì§€ ì•ŠëŠ” APIëŠ” ì ˆëŒ€ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”.
            4. APIëŠ” ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”:
            
               METHOD /path - Summary
               Explanation: (ê°€ëŠ¥í•  ê²½ìš° í•œ ì¤„ ì„¤ëª…)
            
            5. ìµœëŒ€ 8ê°œì˜ APIê¹Œì§€ë§Œ ë³´ì—¬ ì£¼ì„¸ìš”.
            6. ì¤‘ë³µ APIëŠ” ì ˆëŒ€ ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”.
            7. ì˜ë¯¸ê°€ ë¶ˆë¶„ëª…í•œ ì§ˆë¬¸ì´ë¼ë„ ê°€ëŠ¥í•œ ë²”ìœ„ì—ì„œ ê°€ì¥ ì ì ˆí•œ APIë¥¼ ì¶”ì²œí•˜ì„¸ìš”.
            8. í•˜ì§€ë§Œ ì •ë§ ê´€ë ¨ APIê°€ ì—†ì„ ê²½ìš° ë‹¤ìŒ ë¬¸ì¥ì„ ì •í™•íˆ ì¶œë ¥í•˜ì„¸ìš”:
               "ì£„ì†¡í•©ë‹ˆë‹¤. í•´ë‹¹ ë‚´ìš©ì„ Swagger ë¬¸ì„œì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            
            9. ë‹µë³€ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”.
            """, swaggerContext, request.message());

        try {
            var prompt = new Prompt(List.of(systemMessage, new UserMessage(userPrompt))); // í”„ë¡¬í”„íŠ¸ êµ¬ì„±
            log.info("ì„¸ì…˜ [{}] LLM í˜¸ì¶œ ì‹œì‘", sessionId);
            var result = chatModel.call(prompt); // LLM í˜¸ì¶œ
            var reply = result.getResult().getOutput().getText(); // ë‹µë³€ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            log.info("ì„¸ì…˜ [{}] LLM ì‘ë‹µ ì™„ë£Œ", sessionId);

            reply = removeDuplicateLines(reply); // ì‘ë‹µ ì¤‘ë³µ ì œê±°
            log.debug("ì„¸ì…˜ [{}] ì¤‘ë³µ ì œê±° í›„ ì‘ë‹µ: {}", sessionId, reply);

            if (!validateResponseRelevance(request.message(), reply, allDocs)) { // ì‘ë‹µ-ì§ˆë¬¸ ë¶ˆì¼ì¹˜ ì‹œ í´ë°±
                log.warn("ì„¸ì…˜ [{}] ì‘ë‹µì´ ì§ˆë¬¸ê³¼ ê´€ë ¨ ì—†ìŒ - í´ë°± ë©”ì‹œì§€ ë°˜í™˜", sessionId);
                var fallbackMessage = "ì£„ì†¡í•©ë‹ˆë‹¤. í•´ë‹¹ ë‚´ìš©ì„ Swagger ë¬¸ì„œì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                sessionService.appendAssistantMessage(sessionId, fallbackMessage);
                var links = List.of(new ApiLink("Swagger ë¬¸ì„œ ì „ì²´ ë³´ê¸°", null, null,
                        apiBaseUrl + "/swagger-ui/index.html"));
                return ResponseEntity.ok(new ChatResponse(sessionId, fallbackMessage, links));
            }

            sessionService.appendAssistantMessage(sessionId, reply); // ìµœì¢… ì‘ë‹µ ì €ì¥

            var mentionedPaths = extractApiPaths(reply); // ì‘ë‹µì—ì„œ /api/... ê²½ë¡œ ì¶”ì¶œ
            log.info("ì„¸ì…˜ [{}] ì‘ë‹µì—ì„œ ì¶”ì¶œëœ API ê²½ë¡œ: {}", sessionId, mentionedPaths);

            var relevantDocs = allDocs.stream()
                    .filter(doc -> mentionedPaths.contains(doc.path())) // ì–¸ê¸‰ëœ ê²½ë¡œë§Œ í•„í„°
                    .limit(8) // ìµœëŒ€ 8ê°œ
                    .toList();

            var links = buildLinks(relevantDocs); // ë§í¬ êµ¬ì„±
            if (links.isEmpty()) { // ê²½ë¡œ ì–¸ê¸‰ ì—†ìœ¼ë©´ Swagger UI ë§í¬ë§Œ ì œê³µ
                links = List.of(new ApiLink("Swagger ë¬¸ì„œ ì „ì²´ ë³´ê¸°", null, null,
                        apiBaseUrl + "/swagger-ui/index.html"));
            }

            log.info("ì„¸ì…˜ [{}] ìƒì„±ëœ ë§í¬ ê°œìˆ˜: {}", sessionId, links.size());
            return ResponseEntity.ok(new ChatResponse(sessionId, reply, links)); // ìµœì¢… ì‘ë‹µ

        } catch (Exception ex) {
            log.error("ì„¸ì…˜ [{}] LLM í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", sessionId, ex); // ì˜ˆì™¸ ë¡œê·¸
            var fallback = "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ìƒë‹´ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            sessionService.appendAssistantMessage(sessionId, fallback);
            return ResponseEntity.ok(new ChatResponse(sessionId, fallback, List.of())); // í´ë°± ì‘ë‹µ
        }
    }

    /*
    ============================================================
    buildSwaggerContext() ìš©ë„
    ============================================================
    - ì¸ë±ì‹±ëœ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ ìµœëŒ€ ê¸€ììˆ˜ ë‚´ì—ì„œ "[METHOD] /path - summary" í˜•íƒœë¡œ ì´ì–´ë¶™ì—¬ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
    ============================================================
    */
    private String buildSwaggerContext(List<Document> documents) {
        var builder = new StringBuilder(); // ëˆ„ì  ë²„í¼
        int charCount = 0; // í˜„ì¬ ëˆ„ì  ê¸¸ì´
        for (var doc : documents) {
            if (charCount >= MAX_CONTEXT_CHARS) break; // ê¸¸ì´ í•œë„ ì´ˆê³¼ ì‹œ ì¢…ë£Œ
            var line = String.format("[%s] %s", doc.httpMethod(), doc.path()); // ê¸°ë³¸ í¬ë§·
            if (doc.summary() != null && !doc.summary().isBlank()) line += " - " + doc.summary(); // ìš”ì•½ ì¶”ê°€
            line += "\n"; // ì¤„ë°”ê¿ˆ
            if (charCount + line.length() > MAX_CONTEXT_CHARS) break; // ë‹¤ìŒ ì¶”ê°€ ì‹œ í•œë„ ì´ˆê³¼ë©´ ì¢…ë£Œ
            builder.append(line); // ì¶”ê°€
            charCount += line.length(); // ê¸¸ì´ ê°±ì‹ 
        }
        return builder.toString().trim(); // íŠ¸ë¦¼ í›„ ë°˜í™˜
    }

    /*
    ============================================================
    removeDuplicateLines() ìš©ë„
    ============================================================
    - LLM ì‘ë‹µ ë¬¸ìì—´ì—ì„œ ë²ˆí˜¸ í”„ë¦¬í”½ìŠ¤(ì˜ˆ: "1. ")ë¥¼ ì œê±°í•œ í›„ ì¤‘ë³µ ë¼ì¸ì„ ì œê±°
    ============================================================
    */
    private String removeDuplicateLines(String text) {
        if (text == null || text.isBlank()) return text; // ë¹ˆ ê°’ ì²˜ë¦¬
        var lines = text.split("\n"); // ì¤„ ë‹¨ìœ„ ë¶„ë¦¬
        var uniqueLines = new java.util.LinkedHashSet<String>(); // ìˆœì„œ ìœ ì§€ + ì¤‘ë³µ ì œê±°
        var normalizedToOriginal = new java.util.HashMap<String, String>(); // ì •ê·œí™”â†’ì›ë¬¸ ë§¤í•‘
        for (var line : lines) {
            if (line.trim().isEmpty()) continue; // ë¹ˆ ì¤„ ìŠ¤í‚µ
            var normalized = line.replaceAll("^\\d+\\.\\s*", "").trim(); // ë²ˆí˜¸ í”„ë¦¬í”½ìŠ¤ ì œê±°
            if (!normalizedToOriginal.containsKey(normalized)) { // ì‹ ê·œ ë¼ì¸ë§Œ ì¶”ê°€
                normalizedToOriginal.put(normalized, line);
                uniqueLines.add(line);
            }
        }
        return String.join("\n", uniqueLines); // ì¬ì¡°í•©
    }

    /*
    ============================================================
    validateResponseRelevance() ìš©ë„
    ============================================================
    - ì§ˆë¬¸ í‚¤ì›Œë“œì™€ LLM ì‘ë‹µì´ ì–¸ê¸‰í•œ API ë¬¸ì„œê°€ ì˜ë¯¸ì ìœ¼ë¡œ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦(ë¶ˆì¼ì¹˜ ì‹œ í´ë°± ìœ ë„)
    ============================================================
    */
    private boolean validateResponseRelevance(String question, String reply, List<Document> allDocs) {
        if (reply.contains("ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")) return true; // í´ë°± ë©”ì‹œì§€ëŠ” í†µê³¼
        var mentionedPaths = extractApiPaths(reply); // ì‘ë‹µì—ì„œ ê²½ë¡œ ì¶”ì¶œ
        if (mentionedPaths.isEmpty()) return true; // ê²½ë¡œ ì–¸ê¸‰ ì—†ìœ¼ë©´ ì¼ë°˜ ì‘ë‹µìœ¼ë¡œ í†µê³¼
        var questionKeywords = extractKeywords(question); // ì§ˆë¬¸ í‚¤ì›Œë“œ ì¶”ì¶œ
        if (questionKeywords.isEmpty()) return true; // í‚¤ì›Œë“œ ì—†ìŒ â†’ í†µê³¼
        for (var path : mentionedPaths) { // ì–¸ê¸‰ ê²½ë¡œë“¤ ìˆœíšŒ
            for (var doc : allDocs) {
                if (doc.path().equals(path)) { // ë™ì¼ ê²½ë¡œ ë¬¸ì„œ ì°¾ê¸°
                    var apiText = (doc.summary() + " " + doc.description() + " " + doc.path()).toLowerCase(); // ë¹„êµ í…ìŠ¤íŠ¸
                    for (var keyword : questionKeywords) {
                        if (apiText.contains(keyword.toLowerCase())) return true; // í•˜ë‚˜ë¼ë„ ë§¤ì¹­ë˜ë©´ ê´€ë ¨ ìˆìŒ
                    }
                }
            }
        }
        log.warn("ì§ˆë¬¸ í‚¤ì›Œë“œ [{}]ê°€ ì‘ë‹µ API [{}]ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ", questionKeywords, mentionedPaths); // ë¶ˆì¼ì¹˜ ë¡œê·¸
        return false; // ê´€ë ¨ ì—†ìŒ
    }

    /*
    ============================================================
    extractKeywords() ìš©ë„
    ============================================================
    - ì‚¬ì „ ì •ì˜ëœ ë„ë©”ì¸ í‚¤ì›Œë“œ ëª©ë¡ì„ ê¸°ì¤€ìœ¼ë¡œ ì§ˆë¬¸ ë¬¸ìì—´ì— í¬í•¨ëœ í‚¤ì›Œë“œë§Œ ì„ ë³„
    ============================================================
    */
    private List<String> extractKeywords(String question) {
        var keywords = new java.util.ArrayList<String>(); // ê²°ê³¼ ë¦¬ìŠ¤íŠ¸
        var lower = question == null ? "" : question.toLowerCase(); // ì†Œë¬¸ì ë³€í™˜
        for (var keyword : DOMAIN_KEYWORDS) { // ë„ë©”ì¸ ì‚¬ì „ ìˆœíšŒ
            if (lower.contains(keyword.toLowerCase())) keywords.add(keyword); // í¬í•¨ë˜ë©´ ì¶”ê°€
        }
        return keywords; // ë°˜í™˜
    }

    /*
    ============================================================
    extractApiPaths() ìš©ë„
    ============================================================
    - ì‘ë‹µ í…ìŠ¤íŠ¸ì—ì„œ `/api/...` ê²½ë¡œë¥¼ ì •ê·œì‹ìœ¼ë¡œ ì¶”ì¶œ(ë°±í‹± ê°ì‹¸ì§„ ê²½ìš°/ì¼ë°˜ í…ìŠ¤íŠ¸ ëª¨ë‘ ì²˜ë¦¬)
    ============================================================
    */
    private java.util.Set<String> extractApiPaths(String text) {
        if (text == null || text.isBlank()) return java.util.Set.of(); // ë¹ˆ ì…ë ¥ ì²˜ë¦¬
        var paths = new java.util.LinkedHashSet<String>(); // ì¤‘ë³µ ì œê±° ìœ„í•´ Set ì‚¬ìš©
        var m1 = API_CODE_PATTERN.matcher(text); // ë°±í‹± í¬í•¨ íŒ¨í„´
        while (m1.find()) paths.add(m1.group(1)); // ê·¸ë£¹ ìº¡ì²˜ ì¶”ê°€
        var m2 = API_PLAIN_PATTERN.matcher(text); // ì¼ë°˜ íŒ¨í„´
        while (m2.find()) paths.add(m2.group(1)); // ê·¸ë£¹ ìº¡ì²˜ ì¶”ê°€
        return paths; // ê²½ë¡œ ì§‘í•© ë°˜í™˜
    }

    /*
    ============================================================
    buildLinks() ìš©ë„
    ============================================================
    - ê´€ë ¨ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ UIì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ë§í¬(title/method/path/url)ë¡œ ë³€í™˜.
    - ìš”ì•½ì´ ì—†ìœ¼ë©´ "METHOD /path" í˜•ì‹ìœ¼ë¡œ ì œëª© ëŒ€ì²´, ë§í¬ëŠ” baseUrl + path.
    ============================================================
    */
    private List<ApiLink> buildLinks(List<Document> documents) {
        if (documents == null || documents.isEmpty()) return List.of(); // ë¹ˆ ì…ë ¥ ì²˜ë¦¬
        var unique = new java.util.LinkedHashMap<String, ApiLink>(); // ì¤‘ë³µ(title/ê²½ë¡œ) ë°©ì§€ ìœ„í•´ ë§µ ì‚¬ìš©
        for (var doc : documents) {
            if (doc == null || doc.path() == null || doc.path().isBlank()) continue; // ë¬´íš¨ ë¬¸ì„œ ìŠ¤í‚µ
            var path = doc.path();
            var method = doc.httpMethod();
            var summary = doc.summary();
            var title = (summary != null && !summary.isBlank()) ? summary : ((method != null ? method + " " : "") + path); // ì œëª© ê²°ì •
            var url = apiBaseUrl + path; // ì‹¤ì œ ì´ë™ URL
            unique.computeIfAbsent(path + "|" + method, k -> new ApiLink(title, method, path, url)); // í‚¤ ì¤‘ë³µ ë°©ì§€
        }
        return List.copyOf(unique.values()); // ë§í¬ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    }

    // ìš”ì²­/ì‘ë‹µ ë ˆì½”ë“œ: ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ì…ì¶œë ¥ ìµœì†Œ í‘œí˜„
    public record ChatRequest(String sessionId, @NotBlank String message) {}
    public record ChatResponse(String sessionId, String reply, List<ApiLink> links) {}
    public record ApiLink(String title, String method, String path, String url) {}
}