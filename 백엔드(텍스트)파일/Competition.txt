// CompetitionUpdateRequest.java
package com.example.demo.domain.competition.dtos;

import jakarta.validation.constraints.NotBlank;

import java.math.BigDecimal;
import java.time.LocalDateTime;

public record CompetitionUpdateRequest(
        @NotBlank String title,
        String description,
        String detail,                  // âœ… ìƒì„¸ ì„¤ëª…
        @NotBlank String status,        // ë¬¸ìì—´ë¡œ ë“¤ì–´ì™€ì„œ ì„œë¹„ìŠ¤ì—ì„œ valueOf
        LocalDateTime startAt,
        LocalDateTime endAt,
        String evaluationMetric,        // âœ… í‰ê°€ ì§€í‘œ
        BigDecimal prizeTotal           // âœ… ìƒê¸ˆ
) {}

// CompetitionCSVSave.java
package com.example.demo.domain.competition.entity;

import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;

@Entity
@Table(name = "competitioncsvsave")
@Getter @Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class CompetitionCSVSave {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long competitionId;

    private String userid;  // ì œì¶œì

    private String fileName;

    private String filePath;

    private LocalDateTime submittedAt;

    private Double score;
}

// CompetitionCSVSaveRepository.java
package com.example.demo.domain.competition.repository;

import com.example.demo.domain.competition.entity.CompetitionCSVSave;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CompetitionCSVSaveRepository extends JpaRepository<CompetitionCSVSave, Long> {
    boolean existsByCompetitionIdAndUserid(Long competitionId, String userid);
}


// CompetitionMapper.java
package com.example.demo.domain.competition.dtos;

import com.example.demo.domain.competition.entity.Competition;

public final class CompetitionMapper {
    private CompetitionMapper() {
    }

    public static CompetitionDto toDto(Competition c) {
        return new CompetitionDto(
                c.getId(),
                c.getTitle(),
                c.getPurpose(),
                c.getDetail(),
                c.getStatus(),
                c.getStartAt(),
                c.getEndAt(),
                c.getEvaluationMetric(),
                c.getPrizeTotal(),
                c.getParticipantCount(),
                c.getCreatedAt(),
                c.getTrainFilePath(),
                c.getTestFilePath(),
                c.getTrainDatasetSaveId(),
                c.getTestDatasetSaveId()
        );
    }
}


// Status.java
package com.example.demo.domain.competition.entity;

public enum Status {
    OPEN, CLOSED, UPCOMING
}

// Competition.java
package com.example.demo.domain.competition.entity;

import jakarta.persistence.*;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import lombok.Data;
import lombok.Getter;
import lombok.Setter;
import org.hibernate.annotations.CreationTimestamp;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@Entity
@Getter @Setter
@Table(name = "competitions")
public class Competition {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @NotBlank
    @Column(nullable = false, length = 200)
    private String title; // ëŒ€íšŒëª…

    @Column(columnDefinition = "TEXT")
    private String purpose; // ëŒ€íšŒ ëª©ì  (DTOì˜ descriptionê³¼ ë§¤í•‘)

    @NotNull
    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 20)
    private Status status = Status.UPCOMING; // ì§„í–‰ ìƒíƒœ (UPCOMING, OPEN, CLOSED)

    private LocalDateTime startAt; // ì‹œì‘ì¼
    private LocalDateTime endAt;   // ì¢…ë£Œì¼

    @Column(columnDefinition = "TEXT")
    private String detail;

    @Column(length = 40)
    private String evaluationMetric = "ACCURACY"; // í‰ê°€ ì§€í‘œ (ê¸°ë³¸ê°’)

    @Column(precision = 12, scale = 2)
    private BigDecimal prizeTotal; // ì´ ìƒê¸ˆ (null ê°€ëŠ¥)

    @Column(nullable = false)
    private Integer participantCount = 0; // ì°¸ê°€ì ìˆ˜ (ê¸°ë³¸ 0)

    @CreationTimestamp
    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt; // ìƒì„±ì¼

    @Column
    private LocalDateTime updatedAt; // ìˆ˜ì •ì¼

    @PreUpdate
    void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }

    @Column
    private Long trainDatasetSaveId;

    @Column
    private Long testDatasetSaveId;

    @Column
    private String trainFilePath;

    @Column
    private String testFilePath;

    @Column
    private String customScorePath; //ì¶”ê°€
}

// CompetitionDto.java
package com.example.demo.domain.competition.dtos;

import com.example.demo.domain.competition.entity.Status;

import java.math.BigDecimal;
import java.time.LocalDateTime;

public record CompetitionDto(
        Long id,
        String title,
        String purpose,           // ëª©ì (í•œ ì¤„)
        String detail,            // âœ… ìƒì„¸ ì„¤ëª…
        Status status,
        LocalDateTime startAt,
        LocalDateTime endAt,
        String evaluationMetric,
        BigDecimal prizeTotal,
        Integer participantCount,
        LocalDateTime createdAt,
        String trainFilePath,
        String testFilePath,
        Long trainDatasetSaveId,
        Long testDatasetSaveId
) {}

// CompetitionRepository.java
package com.example.demo.domain.competition.repository;

import com.example.demo.domain.competition.entity.Competition;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;

public interface CompetitionRepository
        extends JpaRepository<Competition, Long>, JpaSpecificationExecutor<Competition> {
}

// CompetitionCreateRequest.java
package com.example.demo.domain.competition.dtos;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;

import java.math.BigDecimal;
import java.time.LocalDateTime;

public record CompetitionCreateRequest(
        @NotBlank String title,
        String description,              // ëª©ì (=ì—”í‹°í‹° purpose)
        String detail,                   // âœ… ìƒì„¸ ì„¤ëª…
        @NotNull String status,          // UPCOMING/OPEN/CLOSED (í”„ë¡ íŠ¸ì— ì•ˆ ë³´ì´ë”ë¼ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì „ì†¡)
        LocalDateTime startAt,
        LocalDateTime endAt,
        String evaluationMetric,         // âœ… í‰ê°€ ì§€í‘œ (ì˜ˆ: ACCURACY/F1/AUC/RMSE/MAE)
        BigDecimal prizeTotal            // âœ… ìƒê¸ˆ
) {}

// fileName: ScoreService.java
package com.example.demo.domain.competition.service;

import com.example.demo.domain.competition.entity.Competition;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.nio.file.Paths;
import java.util.concurrent.CompletableFuture;

@Slf4j
@Service
@RequiredArgsConstructor
public class ScoreService {

    public double runScore(Competition competition, String answerPath, String submitPath) {

        String script;

        // 1) ì»¤ìŠ¤í…€ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‹¤í–‰
        if (competition.getCustomScorePath() != null) {
            script = competition.getCustomScorePath();
        }
        // 2) í‰ê°€ ì§€í‘œë³„ ìŠ¤í¬ë¦½íŠ¸ ì„ íƒ
        else {
            script = switch (competition.getEvaluationMetric()) {
                case "F1" -> "ml/score_f1.py";
                case "AUC" -> "ml/score_auc.py";
                case "RMSE" -> "ml/score_rmse.py";
                case "MAE" -> "ml/score_mae.py";
                default -> "ml/score_accuracy.py";
            };
        }
        String absoluteScriptPath = Paths.get(script).toAbsolutePath().toString();

        return runPython(absoluteScriptPath, answerPath, submitPath);
    }

    private double runPython(String script, String answerPath, String submitPath) {
        try {
            String scriptPath = Paths.get(script).toAbsolutePath().toString();
            log.error("SCRIPT PATH = {}", scriptPath);

            ProcessBuilder pb = new ProcessBuilder(
                    "python",
                    scriptPath,
                    answerPath,
                    submitPath
            );

            pb.redirectErrorStream(true);
            Process process = pb.start();

            BufferedReader br = new BufferedReader(
                    new InputStreamReader(process.getInputStream())
            );

            StringBuilder output = new StringBuilder();
            String line;
            String lastLine = null;

            // Python ì¶œë ¥ ì „ì²´ ì½ê¸° + ë§ˆì§€ë§‰ ì¤„ ì €ì¥
            while ((line = br.readLine()) != null) {
                output.append(line).append("\n");
                lastLine = line;
            }

            int exit = process.waitFor();

            if (exit != 0) {
                log.error("ğŸ”¥ Python ì±„ì  ì‹¤íŒ¨(exit={}):\n{}", exit, output);
                return -1;
            }

            if (lastLine == null) {
                log.error("ğŸ”¥ Python ì¶œë ¥ì´ ì—†ìŠµë‹ˆë‹¤.");
                return -1;
            }

            log.info("ğŸ”¥ Python ì¶œë ¥(last line) = {}", lastLine);

            return Double.parseDouble(lastLine.trim());

        } catch (Exception e) {
            log.error("ğŸ”¥ ì±„ì  ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);
            return -1;
        }
    }
}



// fileName: CSVSaveService.java
package com.example.demo.domain.competition.service;

import com.example.demo.domain.competition.entity.Competition;
import com.example.demo.domain.competition.entity.CompetitionCSVSave;
import com.example.demo.domain.user.entity.User;
import org.springframework.web.multipart.MultipartFile;

public interface CSVSaveService {
    CompetitionCSVSave saveDatasetFile(MultipartFile file, Competition competition, String type);

    CompetitionCSVSave saveCSV(MultipartFile file, User user, Competition competition);
}


// fileName: CompetitionService.java
package com.example.demo.domain.competition.service;

import com.example.demo.domain.competition.dtos.CompetitionCreateRequest;
import com.example.demo.domain.competition.dtos.CompetitionDto;
import com.example.demo.domain.competition.dtos.CompetitionMapper;
import com.example.demo.domain.competition.dtos.CompetitionUpdateRequest;
import com.example.demo.domain.competition.entity.Competition;
import com.example.demo.domain.competition.entity.CompetitionCSVSave;
import com.example.demo.domain.competition.entity.Status;
import com.example.demo.domain.competition.repository.CompetitionRepository;
import com.example.demo.global.exception.ConflictException;
import com.example.demo.global.exception.ResourceNotFoundException;
import jakarta.persistence.criteria.Predicate;
import lombok.RequiredArgsConstructor;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.dao.EmptyResultDataAccessException;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;
import java.util.List;

@Service
@RequiredArgsConstructor
public class CompetitionService {

    private final CompetitionRepository repository;

    // âœ… CSV ì €ì¥ ì „ë‹´ ì„œë¹„ìŠ¤ ì£¼ì… (dataset + ì œì¶œ CSV)
    private final CSVSaveService csvSaveService;

    // íŒŒì¼ ì €ì¥ ë£¨íŠ¸(ë¡œì»¬)
    private static final String ROOT_PATH = "uploads/competitions/";

    @Transactional(readOnly = true)
    public Page<CompetitionDto> search(Status status, String keyword, int page, int size, Sort sort) {
        Specification<Competition> spec = (root, q, cb) -> {
            Predicate p = cb.conjunction();
            if (status != null) {
                p = cb.and(p, cb.equal(root.get("status"), status));
            }
            if (keyword != null && !keyword.isBlank()) {
                String like = "%" + keyword.trim() + "%";
                p = cb.and(p, cb.like(root.get("title"), like));
            }
            return p;
        };

        Pageable pageable = PageRequest.of(page, size, sort);
        return repository.findAll(spec, pageable).map(CompetitionMapper::toDto);
    }

    @Transactional(readOnly = true)
    public CompetitionDto get(Long id) {
        Competition c = repository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("Competition not found: " + id));
        return CompetitionMapper.toDto(c);
    }

    // ìƒì„±
    @Transactional
    public CompetitionDto create(CompetitionCreateRequest req) {
        Competition c = new Competition();
        c.setTitle(req.title());
        c.setPurpose(req.description());
        c.setDetail(req.detail());
        c.setStatus(Status.valueOf(req.status()));
        c.setStartAt(req.startAt());
        c.setEndAt(req.endAt());
        if (req.evaluationMetric() != null) c.setEvaluationMetric(req.evaluationMetric());
        if (req.prizeTotal() != null)       c.setPrizeTotal(req.prizeTotal());
        Competition saved = repository.save(c);
        return CompetitionMapper.toDto(saved);
    }

    // íŒŒì¼ ì—…ë¡œë“œ
    @Transactional
    public CompetitionDto createWithFiles(
            CompetitionCreateRequest req,
            MultipartFile trainFile,
            MultipartFile testFile,
            MultipartFile customScoreFile
    ) {
        try {
            // 1) ê¸°ë³¸ ì—”í‹°í‹° ì €ì¥ (ID ë¨¼ì € ìƒì„±)
            Competition c = new Competition();
            c.setTitle(req.title());
            c.setPurpose(req.description());
            c.setDetail(req.detail());
            c.setStatus(Status.valueOf(req.status()));
            c.setStartAt(req.startAt());
            c.setEndAt(req.endAt());
            if (req.evaluationMetric() != null) c.setEvaluationMetric(req.evaluationMetric());
            if (req.prizeTotal() != null)       c.setPrizeTotal(req.prizeTotal());

            Competition saved = repository.save(c);

            // 2) íŒŒì¼ ì €ì¥ ê²½ë¡œ ìƒì„±
//            String compDir = ROOT_PATH + saved.getId() + "/";
//            File dir = new File(compDir);
//            if (!dir.exists()) dir.mkdirs();
            // 2) CSV ì €ì¥
            CompetitionCSVSave trainSave = csvSaveService.saveDatasetFile(trainFile, saved, "train");
            CompetitionCSVSave testSave  = csvSaveService.saveDatasetFile(testFile, saved, "test");

            // 2-1) ì»¤ìŠ¤í…€ score.py ì—…ë¡œë“œ ì²˜ë¦¬
            if (customScoreFile != null && !customScoreFile.isEmpty()) {
                String scorePath = "uploads/competitions/" + saved.getId() + "/score.py";

                File scoreFile = new File(scorePath);
                scoreFile.getParentFile().mkdirs(); // ë””ë ‰í† ë¦¬ ìƒì„±
                customScoreFile.transferTo(scoreFile);

                saved.setCustomScorePath(scorePath);
            }

            // 3) íŒŒì¼ ì €ì¥
            // train.csv
//            String trainPath = compDir + "train.csv";
//            Files.copy(trainFile.getInputStream(), Path.of(trainPath),
//                    StandardCopyOption.REPLACE_EXISTING);
//
//            // test.csv
//            String testPath = compDir + "test.csv";
//            Files.copy(testFile.getInputStream(), Path.of(testPath),
//                    StandardCopyOption.REPLACE_EXISTING);

            // 4) ì—”í‹°í‹°ì— íŒŒì¼ ê²½ë¡œ ê¸°ë¡
//            saved.setTrainFilePath("/" + trainPath);
//            saved.setTestFilePath("/" + testPath);
            // 3) Competitionì— ID + íŒŒì¼ ê²½ë¡œ ì €ì¥
            saved.setTrainDatasetSaveId(trainSave.getId());
            saved.setTestDatasetSaveId(testSave.getId());

            saved.setTrainFilePath(trainSave.getFilePath());
            saved.setTestFilePath(testSave.getFilePath());

            repository.save(saved);

            // 5) DTO ë³€í™˜ í›„ ë°˜í™˜
            return CompetitionMapper.toDto(saved);

        } catch (Exception e) {
            throw new RuntimeException("ëŒ€íšŒ ìƒì„± ì¤‘ íŒŒì¼ ì €ì¥ ì˜¤ë¥˜: " + e.getMessage(), e);
        }
    }

    // ìˆ˜ì •
    @Transactional
    public CompetitionDto update(Long id, CompetitionUpdateRequest req) {
        Competition c = repository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Competition not found: " + id));

        c.setTitle(req.title());
        c.setPurpose(req.description());
        c.setDetail(req.detail());                               // âœ… ìƒì„¸ ì„¤ëª…
        if (req.status() != null) c.setStatus(Status.valueOf(req.status()));
        c.setStartAt(req.startAt());
        c.setEndAt(req.endAt());
        if (req.evaluationMetric() != null) c.setEvaluationMetric(req.evaluationMetric()); // âœ…
        if (req.prizeTotal() != null)       c.setPrizeTotal(req.prizeTotal());             // âœ…

        Competition updated = repository.save(c);
        return CompetitionMapper.toDto(updated);
    }

    // ì‚­ì œ
    @Transactional
    public void delete(Long id) {
        try {
            repository.deleteById(id);
        } catch (EmptyResultDataAccessException e) {
            throw new ResourceNotFoundException("Competition not found: " + id);
        } catch (DataIntegrityViolationException e) {
            throw new ConflictException("ì°¸ì¡° ì¤‘ì¸ ë°ì´í„°ê°€ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + id);
        }
    }

    // ==========================================
    // CSV ì œì¶œìš© Competition ì—”í‹°í‹° ì¡°íšŒ
    // ==========================================
    @Transactional(readOnly = true)
    public Competition findEntity(Long id) {
        return repository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Competition not found: " + id));
    }

}


// fileName: CSVSaveServiceImpl.java
package com.example.demo.domain.competition.service.impl;

import com.example.demo.domain.competition.entity.Competition;
import com.example.demo.domain.competition.entity.CompetitionCSVSave;
import com.example.demo.domain.competition.repository.CompetitionCSVSaveRepository;
import com.example.demo.domain.competition.repository.CompetitionRepository;
import com.example.demo.domain.competition.service.CSVSaveService;
import com.example.demo.domain.competition.service.ScoreService;
import com.example.demo.domain.leaderboard.service.LeaderboardService;
import com.example.demo.domain.user.entity.User;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.time.LocalDateTime;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class CSVSaveServiceImpl implements CSVSaveService {

    private final CompetitionCSVSaveRepository csvSaveRepository;
    private final ScoreService scoreService;
    private final LeaderboardService leaderboardService;
    private final CompetitionRepository competitionRepository;

    @Value("${file.upload-dir}") // ê°’ ì£¼ì…
    private String uploadDir;

    /* ============================================================
     *  ğŸ”¥ [A] Dataset ì €ì¥ (train.csv / test.csv)
     *      - ëŒ€íšŒ ìƒì„± ì‹œ í˜¸ì¶œë¨
     *      - userid ì—†ìŒ
     *      - score ì—†ìŒ
     * ============================================================ */
    @Override
    public CompetitionCSVSave saveDatasetFile(MultipartFile file,
                                              Competition competition,
                                              String type) {

        // ê²½ë¡œ: (ì„¤ì •ëœê²½ë¡œ)/dataset/{competitionId}/
        Path rootPath = Paths.get(uploadDir).toAbsolutePath().normalize();
        Path targetDir = rootPath.resolve("dataset")
                .resolve(String.valueOf(competition.getId()));

        File dir = targetDir.toFile();
        if (!dir.exists()) dir.mkdirs();

        // íŒŒì¼ëª…: train.csv ë˜ëŠ” test.csv ê³ ì •
        String fileName = type.equals("train") ? "train.csv" : "test.csv";
        Path filePath = targetDir.resolve(fileName);

        // ì‹¤ì œ íŒŒì¼ ì €ì¥
        try {
            Files.copy(file.getInputStream(), filePath,
                    StandardCopyOption.REPLACE_EXISTING);
        } catch (IOException e) {
            throw new RuntimeException("CSV ì €ì¥ ì‹¤íŒ¨", e);
        }

        // DB ê¸°ë¡ ì €ì¥
        CompetitionCSVSave save = CompetitionCSVSave.builder()
                .competitionId(competition.getId())
                .userid(null)
                .fileName(fileName)
                .filePath(filePath.toString()) // Path ê°ì²´ì˜ ë¬¸ìì—´ ì‚¬ìš©
                .submittedAt(LocalDateTime.now())
                .score(null)
                .build();

        return csvSaveRepository.save(save);
    }


    /* ============================================================
     *  ğŸ”¥ [B] ì°¸ê°€ì ì œì¶œ CSV ì €ì¥
     *      - ì°¸ê°€ìê°€ ì œì¶œí•  ë•Œ í˜¸ì¶œë¨
     *      - userid ê¸°ë¡ í•„ìš”
     *      - score ê¸°ë³¸ê°’ 0.0 (AI ì±„ì  í›„ ì—…ë°ì´íŠ¸)
     * ============================================================ */
    @Override
    public CompetitionCSVSave saveCSV(MultipartFile file,
                                      User user,
                                      Competition competition) {

        // ì—…ë¡œë“œ ê²½ë¡œ = /uploads/submission/{competitionId}/
        Path rootPath = Paths.get(uploadDir).toAbsolutePath().normalize();
        Path targetDir = rootPath.resolve("submission")
                .resolve(String.valueOf(competition.getId()));

        File dir = targetDir.toFile();
        if (!dir.exists()) dir.mkdirs();

        // ì›ë³¸ íŒŒì¼ëª… ìœ ì§€í•˜ë˜ UUID ë¶™ì—¬ ì¶©ëŒ ë°©ì§€
        String originalName = file.getOriginalFilename();
        String storedName = UUID.randomUUID() + "_" + originalName;

        Path filePath = targetDir.resolve(storedName);

        // ì‹¤ì œ íŒŒì¼ ë³µì‚¬
        try {
            Files.copy(file.getInputStream(), filePath,
                    StandardCopyOption.REPLACE_EXISTING);
        } catch (IOException e) {
            throw new RuntimeException("ì œì¶œ CSV ì €ì¥ ì‹¤íŒ¨", e);
        }

        // ì œì¶œ ê¸°ë¡ DB ì €ì¥
        CompetitionCSVSave save = CompetitionCSVSave.builder()
                .competitionId(competition.getId())
                .userid(user.getUserid())
                .fileName(originalName)
                .filePath(filePath.toString()) // Path ê°ì²´ì˜ ë¬¸ìì—´ ì‚¬ìš©
                .submittedAt(LocalDateTime.now())
                .score(0.0)
                .build();

        save = csvSaveRepository.save(save);

        // 2) ì ìˆ˜ ê³„ì‚° (í•µì‹¬ ë¶€ë¶„)
        String answerPath = competition.getTestFilePath();
        if (answerPath == null || answerPath.isBlank()) {
            throw new RuntimeException("ì •ë‹µ íŒŒì¼(test.csv) ê²½ë¡œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
        String submitPath = save.getFilePath();

        // ScoreService ì‹¤í–‰ â†’ Python ì±„ì 
        double score = scoreService.runScore(competition, answerPath, submitPath);

        // ê³„ì‚°ëœ ì ìˆ˜ ì €ì¥
        save.setScore(score);
        csvSaveRepository.save(save);

        // ì°¸ê°€ì ìˆ˜ +1
        boolean isFirstSubmission =
                !csvSaveRepository.existsByCompetitionIdAndUserid(competition.getId(), user.getUserid());
        if (isFirstSubmission) {
            competition.setParticipantCount(competition.getParticipantCount() + 1);
            competitionRepository.save(competition);
        }

        // ë¦¬ë”ë³´ë“œ ë°˜ì˜
        leaderboardService.leaderBoardAdd(user, competition, save);

        return save;
    }

}

