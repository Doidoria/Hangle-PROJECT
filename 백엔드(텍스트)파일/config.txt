// SecurityConfig.java
package com.example.demo.config;

import com.example.demo.config.auth.jwt.JwtAuthorizationFilter;
import com.example.demo.config.auth.jwt.JwtProperties;
import com.example.demo.config.auth.jwt.JwtTokenProvider;
import com.example.demo.config.auth.Handler.CustomLoginSuccessHandler;
import com.example.demo.config.auth.Handler.CustomLogoutHandler;
import com.example.demo.config.auth.Handler.CustomLogoutSuccessHandler;
import com.example.demo.config.auth.jwt.TokenInfo;
import com.example.demo.config.auth.oauth.PrincipalDetailsOAuth2Service;
import com.example.demo.config.auth.redis.RedisUtil;
import com.example.demo.domain.user.repository.UserRepository;
import com.example.demo.global.exceptionHandler.CustomAccessDeniedHandler;
import com.example.demo.global.exceptionHandler.CustomAuthenticationEntryPoint;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseCookie;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.security.web.authentication.logout.LogoutFilter;
import org.springframework.security.web.context.NullSecurityContextRepository;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;

import java.util.Arrays;
import java.util.Collections;

@Configuration
@EnableWebSecurity(debug = false)
@RequiredArgsConstructor
public class SecurityConfig {

	private final CustomLoginSuccessHandler customLoginSuccessHandler;
	private final CustomLogoutHandler customLogoutHandler;
	private final CustomLogoutSuccessHandler customLogoutSuccessHandler;
	private final UserRepository userRepository;
	private final JwtTokenProvider jwtTokenProvider;
	private final RedisUtil redisUtil;
    private final PrincipalDetailsOAuth2Service principalDetailsOAuth2Service;
    private final CustomAuthenticationEntryPoint customAuthenticationEntryPoint;
    private final CustomAccessDeniedHandler customAccessDeniedHandler;

    @Bean
    public JwtAuthorizationFilter jwtAuthorizationFilter() {
        return new JwtAuthorizationFilter(userRepository, jwtTokenProvider, redisUtil);
    }

	@Bean
    @Order(2)
	protected SecurityFilterChain configure(HttpSecurity http, JwtAuthorizationFilter jwtAuthorizationFilter) throws Exception {
        http.securityMatcher("/**");
        // CORS í™œì„±í™”
        http.cors(cors -> cors.configurationSource(corsConfigurationSource()));
		// CSRFë¹„í™œì„±í™”
		http.csrf((config)->{config.disable();});
        http.exceptionHandling(ex -> ex
                .authenticationEntryPoint(customAuthenticationEntryPoint) // 401 JSON
                .accessDeniedHandler(customAccessDeniedHandler)           // 403 JSON
        )
                .formLogin(AbstractHttpConfigurer::disable)  // â˜… ë¡œê·¸ì¸ í¼ ë¦¬ë‹¤ì´ë ‰íŠ¸ ê¸ˆì§€
                .logout(AbstractHttpConfigurer::disable);    // API ì²´ì¸ì—ëŠ” ë¶ˆí•„ìš”

		//ê¶Œí•œì²´í¬
        http.authorizeHttpRequests(auth -> {
            auth.requestMatchers(
                    "/", "/index.html",
                    "/css/**", "/js/**", "/images/**",
                    "/favicon.ico",
                    "/login", "/join", "/validate/**",
                    "/swagger-ui/**", "/v3/api-docs/**",
                    "/oauth2/**",
                    "/error"
            ).permitAll();
            auth.requestMatchers(HttpMethod.OPTIONS, "/**").permitAll();
            auth.requestMatchers(HttpMethod.POST, "/logout").permitAll();
            auth.requestMatchers(HttpMethod.OPTIONS, "/logout").permitAll();
            auth.requestMatchers("/api/v1/chat/user").permitAll();
            auth.requestMatchers("/api/v1/chat/dev").hasAnyRole("ADMIN", "MANAGER");

            // ê´€ë¦¬ì ë¬¸ì˜ API ê¶Œí•œ ì„¤ì •
            auth.requestMatchers(HttpMethod.GET, "/api/inquiry/admin").hasAnyRole("ADMIN","MANAGER");
            auth.requestMatchers(HttpMethod.POST, "/api/inquiry/admin/*/answer").hasAnyRole("ADMIN","MANAGER");
            auth.requestMatchers(HttpMethod.PUT,  "/api/inquiry/admin/*/answer").hasAnyRole("ADMIN","MANAGER");
            auth.requestMatchers(HttpMethod.DELETE, "/api/inquiry/admin/*").hasRole("ADMIN");

            auth.requestMatchers(HttpMethod.POST, "/api/competitions/{competitionId}/submit").hasRole("USER");
            // ê´€ë¦¬ì ëŒ€íšŒ ê¶Œí•œ ì„¤ì •
            auth.requestMatchers(HttpMethod.PUT, "/api/competitions/**").hasAnyRole("ADMIN", "MANAGER");
            auth.requestMatchers(HttpMethod.DELETE, "/api/competitions/**").hasRole("ADMIN");
            auth.requestMatchers("/api/**").authenticated();
            auth.anyRequest().permitAll();
        });

		//-----------------------------------------------------
		// [ìˆ˜ì •] ë¡œê·¸ì¸(ì§ì ‘ì²˜ë¦¬ - UserRestController)
		//-----------------------------------------------------
		http.formLogin((login)->{
			login.disable();
		});

		//ë¡œê·¸ì•„ì›ƒ
		http.logout((logout)->{
			logout.permitAll();
			logout.addLogoutHandler(customLogoutHandler);
			logout.logoutSuccessHandler(customLogoutSuccessHandler);
		});

		//OAUTH2-CLIENT
		http.oauth2Login(oauth -> oauth
                .loginPage("/login") // ì»¤ìŠ¤í…€ ë¡œê·¸ì¸ í˜ì´ì§€ ìœ ì§€
                .userInfoEndpoint(userInfo -> userInfo.userService(principalDetailsOAuth2Service))
                .defaultSuccessUrl("http://localhost:3000/", true) // ë¡œê·¸ì¸ ì„±ê³µ í›„ React ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                .successHandler(oAuth2LoginSuccessHandler())
                .failureUrl("http://localhost:3000/login?error=true") // ì‹¤íŒ¨ ì‹œ React ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
        );

		//SESSION INVALIDATED
        http.securityContext(c -> c.securityContextRepository(new NullSecurityContextRepository()));
		http.sessionManagement((sessionManagerConfigure)->{
			sessionManagerConfigure.sessionCreationPolicy(SessionCreationPolicy.STATELESS);
		});

        //JWT FILTER ADD
        http.addFilterBefore(jwtAuthorizationFilter, LogoutFilter.class);

		//-----------------------------------------------
		//[ì¶”ê°€] CORS
		//-----------------------------------------------
		http.cors((config)->{
			config.configurationSource(corsConfigurationSource());
		});

		return http.build();
	}

	//-----------------------------------------------------
	//[ì¶”ê°€] CORS
	//-----------------------------------------------------
	@Bean
	CorsConfigurationSource corsConfigurationSource(){
        CorsConfiguration config = new CorsConfiguration();
        // React ê°œë°œ ì„œë²„ ì£¼ì†Œë§Œ í—ˆìš©
        config.setAllowedOriginPatterns(Collections.singletonList("http://localhost:3000")); //"http://localhost:5173"
        // ëª¨ë“  í—¤ë”ì™€ ë©”ì„œë“œ í—ˆìš©
        config.setAllowedHeaders(Collections.singletonList("*"));
        config.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        // ì¿ í‚¤ í¬í•¨ ìš”ì²­ í—ˆìš©
        config.setAllowCredentials(true);
        // ì¿ í‚¤ ì‚­ì œ ì‹œ í•„ìš”í•œ í—¤ë” ë…¸ì¶œ
        config.setExposedHeaders(Arrays.asList("Set-Cookie", "Authorization"));
        // SameSite=None ì¿ í‚¤ë¥¼ ì£¼ê³ ë°›ê¸° ìœ„í•´ ë°˜ë“œì‹œ Secure(false)ë¡œ ì¼ê´€ì„± ìœ ì§€
        // (ì´ê±´ ì¿ í‚¤ ìƒì„±/ì‚­ì œí•  ë•Œ ë§ì¶°ì¤˜ì•¼ í•¨)
        // ì¿ í‚¤ ìƒì„± ì‹œì—ë„ ë™ì¼í•˜ê²Œ secure=false, SameSite=Noneìœ¼ë¡œ ë§Œë“¤ì–´ì•¼ ë¸Œë¼ìš°ì € ì¸ì‹ë¨
        // URL ë§¤í•‘
//        config.setMaxAge(3600L); // 1ì‹œê°„ ë™ì•ˆ ìºì‹± (1ì‹œê°„ ë™ì•ˆì€ ë§¤ë²ˆ OPTIONS ìš”ì²­ì„ ë‹¤ì‹œ ë³´ë‚´ì§€ ì•ŠìŒ)
        org.springframework.web.cors.UrlBasedCorsConfigurationSource source =
                new org.springframework.web.cors.UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);
        return source;
	}

	//-----------------------------------------------------
	//[ì¶”ê°€] ATHENTICATION MANAGER ì„¤ì • - ë¡œê·¸ì¸ ì§ì ‘ì²˜ë¦¬ë¥¼ ìœ„í•œ BEAN
	//-----------------------------------------------------
	@Bean
	public AuthenticationManager authenticationManager(
			AuthenticationConfiguration authenticationConfiguration) throws Exception {
		return authenticationConfiguration.getAuthenticationManager();
	}

    @Bean
    public AuthenticationSuccessHandler oAuth2LoginSuccessHandler() {
        return (request, response, authentication) -> {

            // PrincipalDetails ìºìŠ¤íŒ…
            com.example.demo.config.auth.service.PrincipalDetails principalDetails =
                    (com.example.demo.config.auth.service.PrincipalDetails) authentication.getPrincipal();

            // ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            String username = principalDetails.getUser().getUsername();
            String userid = principalDetails.getUser().getUserid();

            // 1. JWT ìƒì„±
            TokenInfo tokenInfo = jwtTokenProvider.generateToken(authentication);
            // 2. Redisì— Refresh ì €ì¥
            redisUtil.setDataExpire("RT:" + authentication.getName(),
                    tokenInfo.getRefreshToken(),
                    JwtProperties.REFRESH_TOKEN_EXPIRATION_TIME / 1000);
            // 3. ì¿ í‚¤ ìƒì„± (Access + User)
            ResponseCookie accessCookie = ResponseCookie.from(JwtProperties.ACCESS_TOKEN_COOKIE_NAME, tokenInfo.getAccessToken())
                    .httpOnly(true)
                    .secure(true)
                    .sameSite("None")
                    .path("/")
                    .maxAge(JwtProperties.ACCESS_TOKEN_EXPIRATION_TIME / 1000)
                    .build();

            ResponseCookie userCookie = ResponseCookie.from("userid", authentication.getName())
                    .httpOnly(true)
                    .secure(true)
                    .sameSite("None")
                    .path("/")
                    .maxAge(JwtProperties.REFRESH_TOKEN_EXPIRATION_TIME / 1000)
                    .build();

            // Reactë¡œ usernameê³¼ í•¨ê»˜ ë¦¬ë‹¤ì´ë ‰íŠ¸
            String redirectUrl = "http://localhost:3000/oauth-success?username="
                    + java.net.URLEncoder.encode(username, java.nio.charset.StandardCharsets.UTF_8)
                    + "&userid=" + java.net.URLEncoder.encode(userid, java.nio.charset.StandardCharsets.UTF_8);

            response.addHeader(HttpHeaders.SET_COOKIE, accessCookie.toString());
            response.addHeader(HttpHeaders.SET_COOKIE, userCookie.toString());

            response.sendRedirect(redirectUrl);
        };
    }

}
// TxConfig.java
package com.example.demo.config;

import jakarta.persistence.EntityManagerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import javax.sql.DataSource;

@Configuration
@EnableTransactionManagement
public class TxConfig {
    @Autowired
    private DataSource dataSource;

    //    JPA TransactionManager Settings
    @Bean(name="jpaTransactionManager")
    public JpaTransactionManager jpaTransactionManager(EntityManagerFactory entityManagerFactory) {
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(entityManagerFactory);
        transactionManager.setDataSource(dataSource);

        return transactionManager;
    }

}
// SwaggerConfig.java
package com.example.demo.config;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.Components;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.tags.Tag;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.security.SecurityScheme;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

@Configuration
public class SwaggerConfig {

    private static final String SECURITY_SCHEME_NAME = "bearerAuth";

    @Bean
    public OpenAPI customOpenAPI() {

        return new OpenAPI()
                // ì „ì—­ JWT ë³´ì•ˆ ìë™ ì ìš©
                .addSecurityItem(new SecurityRequirement().addList(SECURITY_SCHEME_NAME))

                // JWT Security Scheme ì •ì˜
                .components(new Components()
                        .addSecuritySchemes(SECURITY_SCHEME_NAME,
                                new SecurityScheme()
                                        .name(SECURITY_SCHEME_NAME)
                                        .type(SecurityScheme.Type.HTTP)
                                        .scheme("bearer")
                                        .bearerFormat("JWT")
                        )
                )

                // UI ì •ë³´
                .info(new Info()
                        .title("Hangle API Documentation")
                        .version("v1.0.0")
                        .description("""
                                **Hangle REST API ë¬¸ì„œ**

                                ğŸ” ì¸ì¦ì´ í•„ìš”í•œ APIëŠ” JWT Bearer ì¸ì¦ì´ ìë™ ì ìš©ë©ë‹ˆë‹¤.  
                                ìƒë‹¨ì˜ Authorize ë²„íŠ¼ìœ¼ë¡œ AccessTokenì„ ì…ë ¥í•˜ì„¸ìš”.

                                ëª¨ë“  ë¬¸ì„œëŠ” ApiDocs.java í•œ íŒŒì¼ì—ì„œë§Œ ê´€ë¦¬ë©ë‹ˆë‹¤.
                                """)
                )

                // TAG ìë™ ë“±ë¡ â†’ Controllerì—ì„œ @Tag ì•ˆ ë¶™ì—¬ë„ ë¨
                .tags(List.of(
                        new Tag().name("User").description("ì‚¬ìš©ì ê³„ì • / ì¸ì¦ / ì„¤ì • API"),
                        new Tag().name("Inquiry").description("1:1 ë¬¸ì˜ API"),
                        new Tag().name("Competition").description("ëŒ€íšŒ API"),
                        new Tag().name("PortOne").description("ë³¸ì¸ ì¸ì¦ API")
                ));
    }
}
// JpaConfig.java
package com.example.demo.config;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.domain.EntityScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;

import javax.sql.DataSource;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;

@Configuration
@EntityScan(basePackages = {
        "com.example.demo.domain.user.entity",
        "com.example.demo.domain.competition.entity",
        "com.example.demo.domain.inquiry.entity",
        "com.example.demo.domain.leaderboard.entity",
})
@EnableJpaRepositories
(
                basePackages = {
                        "com.example.demo.domain.user.repository",
                        "com.example.demo.domain.competition.repository",
                        "com.example.demo.domain.myProfile.repository",
                        "com.example.demo.domain.mySetting.repository",
                        "com.example.demo.domain.inquiry.repository",
                        "com.example.demo.domain.leaderboard.repository",
                },
                transactionManagerRef = "jpaTransactionManager"
)
public class JpaConfig {
    @Autowired
    private DataSource dataSource;

    @Bean
    LocalContainerEntityManagerFactoryBean entityManagerFactory() {
        LocalContainerEntityManagerFactoryBean entityManagerFactoryBean = new LocalContainerEntityManagerFactoryBean();
        entityManagerFactoryBean.setDataSource(dataSource);
        entityManagerFactoryBean.setJpaVendorAdapter(new HibernateJpaVendorAdapter());
        entityManagerFactoryBean.setPackagesToScan("com.example.demo.domain");

        Properties jpaProperties = new Properties();

        Map<String, Object> properties = new HashMap<>();
        properties.put("hibernate.hbm2ddl.auto", "update");                         // í•„ìš”ì— ë”°ë¼ 'create', 'validate' ë“±ìœ¼ë¡œ ë³€ê²½
        properties.put("hibernate.dialect", "org.hibernate.dialect.MySQLDialect"); // ì‚¬ìš© ì¤‘ì¸ DBì— ë§ê²Œ ë³€ê²½
        properties.put("hibernate.show_sql", true);
        properties.put("hibernate.format_sql", true);
        properties.put("hibernate.hibernate.jdbc.batch_size", 1000);
        properties.put("hibernate.hibernate.order_inserts", true);
        properties.put("hibernate.order_updates", true);
        properties.put("hibernate.jdbc.batch_versioned_data", true);
        entityManagerFactoryBean.setJpaPropertyMap(properties);

        return entityManagerFactoryBean;
    }
}
// PasswordEncoderConfig.java
package com.example.demo.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
public class PasswordEncoderConfig {
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
// DataSourceConfig.java
package com.example.demo.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import com.zaxxer.hikari.HikariDataSource;

@Configuration
public class DataSourceConfig {

	@Value("${spring.datasource.driver-class-name}")
	private String DBClassName;
	@Value("${spring.datasource.url}")
	private String DBJdbcUrl;
	@Value("${spring.datasource.username}")
	private String username;
	@Value("${spring.datasource.password}")
	private String password;
	@Bean
	public HikariDataSource dataSource()
	{
		HikariDataSource dataSource = new HikariDataSource();
		dataSource.setDriverClassName(DBClassName);
		dataSource.setJdbcUrl(DBJdbcUrl);
		dataSource.setUsername(username);
		dataSource.setPassword(password);

		return dataSource;
	}

}
// CorsConfig.java
package com.example.demo.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig {

    @Bean
    public WebMvcConfigurer webMvcConfigurer() {
        return new WebMvcConfigurer() {
            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/**") // ëª¨ë“  ê²½ë¡œ í—ˆìš© (íŠ¹íˆ /validate ë“±)
                        .allowedOrigins(
                                "http://localhost:3000",
                                "http://localhost:5173"
                        )
                        .allowedMethods("GET","POST","PUT","DELETE","OPTIONS")
                        .allowedHeaders("*")
                        .allowCredentials(true)
                        .exposedHeaders("Set-Cookie") // ì‘ë‹µ ì¿ í‚¤ í—ˆìš©
                        .maxAge(3600);
            }
        };
    }
}
// RedisConfig.java
package com.example.demo.config;

import com.example.demo.config.auth.redis.RedisProperties;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.connection.RedisStandaloneConfiguration;
import org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.repository.configuration.EnableRedisRepositories;
import org.springframework.data.redis.serializer.StringRedisSerializer;

@RequiredArgsConstructor
@Configuration
@EnableRedisRepositories
public class RedisConfig {

    @Autowired
    private RedisProperties redisProperties;

    @Bean
    public RedisConnectionFactory redisConnectionFactory() {
        RedisStandaloneConfiguration config = new RedisStandaloneConfiguration();
        config.setHostName(redisProperties.getHost());
        config.setPort(redisProperties.getPort());
        return new LettuceConnectionFactory(config);
    }

    @Bean
    public RedisTemplate<?, ?> redisTemplate() {
        RedisTemplate<String, String> redisTemplate = new RedisTemplate<>();
        redisTemplate.setConnectionFactory(redisConnectionFactory());
        redisTemplate.setKeySerializer(new StringRedisSerializer());
        redisTemplate.setValueSerializer(new StringRedisSerializer());
        return redisTemplate;
    }

}
// WebConfig.java
package com.example.demo.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

import java.nio.file.Path;
import java.nio.file.Paths;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Value("${file.upload-dir}")
    private String uploadDir;

    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        // ì„¤ì •ëœ ìƒëŒ€ ê²½ë¡œ(./uploads/)ë¥¼ OSì— ë§ëŠ” ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
        Path path = Paths.get(uploadDir).toAbsolutePath().normalize();

        // íŒŒì¼ ì‹œìŠ¤í…œ URI í˜•ì‹(file:///...)ìœ¼ë¡œ ë³€í™˜
        String uploadPath = path.toUri().toString();

        // /uploads/** ë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ ì‹¤ì œ í´ë”ë¡œ ì—°ê²°
        registry.addResourceHandler("/uploads/**")
                .addResourceLocations(uploadPath);
    }
}
// AdminAccountInitializer.java
package com.example.demo.config;

import com.example.demo.domain.user.entity.User;
import com.example.demo.domain.user.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.event.EventListener;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.stereotype.Component;

@Component
public class AdminAccountInitializer {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @EventListener(ApplicationReadyEvent.class)
    public void createDefaultAccounts() {

        createAccountIfNotExists(
                "admin",
                "ê´€ë¦¬ì",
                "ROLE_ADMIN",
                "admin"
        );

        createAccountIfNotExists(
                "manager",
                "ë§¤ë‹ˆì €",
                "ROLE_MANAGER",
                "manager"
        );
    }

    private void createAccountIfNotExists(String userid, String username, String role, String password) {

        if (userRepository.findByUserid(userid) != null) {
            System.out.println("[INIT] ì´ë¯¸ ì¡´ì¬ â†’ " + userid);
            return;
        }

        User user = User.builder()
                .userid(userid)
                .username(username)
                .password(passwordEncoder.encode(password))
                .role(role)
                .isCertified(true)
                .build();

        userRepository.save(user);

        System.out.println("[INIT] ê¸°ë³¸ ê³„ì • ìƒì„± ì™„ë£Œ");
        System.out.println(" â–¶ userid : " + userid);
        System.out.println(" â–¶ role   : " + role);
    }
}