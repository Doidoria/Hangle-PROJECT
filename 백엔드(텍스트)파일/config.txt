==================== DataSourceConfig.java ====================
package com.example.demo.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import com.zaxxer.hikari.HikariDataSource;

@Configuration
public class DataSourceConfig {

	@Value("${spring.datasource.driver-class-name}")
	private String DBClassName;
	@Value("${spring.datasource.url}")
	private String DBJdbcUrl;
	@Value("${spring.datasource.username}")
	private String username;
	@Value("${spring.datasource.password}")
	private String password;
	@Bean
	public HikariDataSource dataSource()
	{
		HikariDataSource dataSource = new HikariDataSource();
		dataSource.setDriverClassName(DBClassName);
		dataSource.setJdbcUrl(DBJdbcUrl);
		dataSource.setUsername(username);
		dataSource.setPassword(password);

		return dataSource;
	}

}

==================== JpaConfig.java ====================
package com.example.demo.config;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.domain.EntityScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;

import javax.sql.DataSource;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;

@Configuration
@EntityScan(basePackages = {
        "com.example.demo.domain.user.entity",
        "com.example.demo.domain.competition.entity",
        "com.example.demo.domain.inquiry.entity",
        "com.example.demo.domain.leaderboard.entity",
})
@EnableJpaRepositories
(
                basePackages = {
                        "com.example.demo.domain.user.repository",
                        "com.example.demo.domain.competition.repository",
                        "com.example.demo.domain.myProfile.repository",
                        "com.example.demo.domain.mySetting.repository",
                        "com.example.demo.domain.inquiry.repository",
                        "com.example.demo.domain.leaderboard.repository",
                },
                transactionManagerRef = "jpaTransactionManager"
)
public class JpaConfig {
    @Autowired
    private DataSource dataSource;

    @Bean
    LocalContainerEntityManagerFactoryBean entityManagerFactory() {
        LocalContainerEntityManagerFactoryBean entityManagerFactoryBean = new LocalContainerEntityManagerFactoryBean();
        entityManagerFactoryBean.setDataSource(dataSource);
        entityManagerFactoryBean.setJpaVendorAdapter(new HibernateJpaVendorAdapter());
        entityManagerFactoryBean.setPackagesToScan("com.example.demo.domain");

        Properties jpaProperties = new Properties();

        Map<String, Object> properties = new HashMap<>();
        properties.put("hibernate.hbm2ddl.auto", "update");                         // í•„ìš”ì— ë”°ë¼ 'create', 'validate' ë“±ìœ¼ë¡œ ë³€ê²½
        properties.put("hibernate.dialect", "org.hibernate.dialect.MySQLDialect"); // ì‚¬ìš© ì¤‘ì¸ DBì— ë§ê²Œ ë³€ê²½
//        properties.put("hibernate.show_sql", true);
//        properties.put("hibernate.format_sql", true);
        properties.put("hibernate.hibernate.jdbc.batch_size", 1000);
        properties.put("hibernate.hibernate.order_inserts", true);
        properties.put("hibernate.order_updates", true);
        properties.put("hibernate.jdbc.batch_versioned_data", true);
        entityManagerFactoryBean.setJpaPropertyMap(properties);

        return entityManagerFactoryBean;
    }
}

==================== PasswordEncoderConfig.java ====================
package com.example.demo.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
public class PasswordEncoderConfig {
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}

==================== RedisConfig.java ====================
package com.example.demo.config;

import com.example.demo.config.auth.redis.RedisProperties;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.connection.RedisStandaloneConfiguration;
import org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.repository.configuration.EnableRedisRepositories;
import org.springframework.data.redis.serializer.StringRedisSerializer;

@RequiredArgsConstructor
@Configuration
@EnableRedisRepositories
public class RedisConfig {

    @Autowired
    private RedisProperties redisProperties;

    @Bean
    public RedisConnectionFactory redisConnectionFactory() {
        RedisStandaloneConfiguration config = new RedisStandaloneConfiguration();
        config.setHostName(redisProperties.getHost());
        config.setPort(redisProperties.getPort());
        return new LettuceConnectionFactory(config);
    }

    @Bean
    public RedisTemplate<?, ?> redisTemplate() {
        RedisTemplate<String, String> redisTemplate = new RedisTemplate<>();
        redisTemplate.setConnectionFactory(redisConnectionFactory());
        redisTemplate.setKeySerializer(new StringRedisSerializer());
        redisTemplate.setValueSerializer(new StringRedisSerializer());
        return redisTemplate;
    }

}

==================== SecurityConfig.java ====================
package com.example.demo.config;

import com.example.demo.config.auth.jwt.JwtAuthorizationFilter;
import com.example.demo.config.auth.jwt.JwtProperties;
import com.example.demo.config.auth.jwt.JwtTokenProvider;
import com.example.demo.config.auth.Handler.CustomLoginSuccessHandler;
import com.example.demo.config.auth.Handler.CustomLogoutHandler;
import com.example.demo.config.auth.Handler.CustomLogoutSuccessHandler;
import com.example.demo.config.auth.jwt.TokenInfo;
import com.example.demo.config.auth.oauth.PrincipalDetailsOAuth2Service;
import com.example.demo.config.auth.redis.RedisUtil;
import com.example.demo.domain.user.repository.UserRepository;
import com.example.demo.global.exceptionHandler.CustomAccessDeniedHandler;
import com.example.demo.global.exceptionHandler.CustomAuthenticationEntryPoint;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseCookie;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.security.web.authentication.logout.LogoutHandler;
import org.springframework.security.web.authentication.logout.LogoutSuccessHandler;
import org.springframework.web.filter.CorsFilter;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final CorsFilter corsFilter;
    private final JwtTokenProvider jwtTokenProvider;
    private final RedisUtil redisUtil;
    private final PrincipalDetailsOAuth2Service principalDetailsOAuth2Service;
    private final UserRepository userRepository;
    private final CustomAccessDeniedHandler customAccessDeniedHandler;
    private final CustomAuthenticationEntryPoint customAuthenticationEntryPoint;

    @Value("${cors.allowed-origins}")
    private String allowedOrigins;

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authenticationConfiguration) throws Exception {
        return authenticationConfiguration.getAuthenticationManager();
    }

    @Bean
    @Order(1)
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http
                .addFilter(corsFilter) // @CrossOrigin(ì¸ì¦X), SecurityFilterì— ë“±ë¡(ì¸ì¦O)
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .formLogin(AbstractHttpConfigurer::disable)
                .httpBasic(AbstractHttpConfigurer::disable)
                .addFilterBefore(new JwtAuthorizationFilter(jwtTokenProvider, redisUtil), UsernamePasswordAuthenticationFilter.class)
                .authorizeHttpRequests(authorize -> authorize
                        // --- Swagger
                        .requestMatchers("/swagger-ui/**", "/v3/api-docs/**", "/swagger-resources/**").permitAll()
                        // --- Static Resources
                        .requestMatchers("/uploads/**", "/favicon.ico", "/error").permitAll()
                        // --- OAuth2 Redirect
                        .requestMatchers("/oauth2/authorization/**").permitAll()
                        .requestMatchers("/login/oauth2/code/**").permitAll()
                        // --- Public APIs
                        .requestMatchers(HttpMethod.GET, "/api/competition/**").permitAll() // ëŒ€íšŒ ëª©ë¡ ì¡°íšŒëŠ” ì „ì²´ ê³µê°œ
                        .requestMatchers(HttpMethod.GET, "/api/competition/{id}").permitAll() // ëŒ€íšŒ ìƒì„¸ ì¡°íšŒëŠ” ì „ì²´ ê³µê°œ
                        .requestMatchers("/api/user/join").permitAll() // íšŒì›ê°€ì…
                        .requestMatchers("/api/user/login").permitAll() // ë¡œê·¸ì¸
                        .requestMatchers("/api/user/check/**").permitAll() // ì•„ì´ë””, ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸
                        .requestMatchers("/api/user/find-userid").permitAll() // ì•„ì´ë”” ì°¾ê¸°
                        .requestMatchers("/api/user/reset-password").permitAll() // ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
                        .requestMatchers("/api/inquiry/**").permitAll() // 1:1 ë¬¸ì˜ (ì¸ì¦ ì—†ì´)
                        .requestMatchers("/api/portone/verify-identity").permitAll() // ë³¸ì¸ ì¸ì¦ ìš”ì²­

                        // --- User (ROLE_USER)
                        .requestMatchers("/api/user/detail").hasAnyRole("USER", "ADMIN", "MANAGER") // ë‚´ ì •ë³´ ì¡°íšŒ
                        .requestMatchers("/api/user/update-profile").hasAnyRole("USER", "ADMIN", "MANAGER") // í”„ë¡œí•„ ìˆ˜ì •
                        .requestMatchers("/api/user/change-password").hasAnyRole("USER", "ADMIN", "MANAGER") // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                        .requestMatchers("/api/user/delete").hasAnyRole("USER", "ADMIN", "MANAGER") // íšŒì› íƒˆí‡´

                        // --- Manager (ROLE_MANAGER)
                        .requestMatchers("/api/manager/**").hasAnyRole("MANAGER", "ADMIN")

                        // --- Admin (ROLE_ADMIN)
                        .requestMatchers("/api/admin/**").hasRole("ADMIN")

                        // --- All authenticated users
                        .requestMatchers("/api/user/logout", "/api/user/reissue-token").hasAnyRole("USER", "ADMIN", "MANAGER")
                        .anyRequest().authenticated()
                )

                // --- Exception Handling
                .exceptionHandling(e -> e
                        .accessDeniedHandler(customAccessDeniedHandler)
                        .authenticationEntryPoint(customAuthenticationEntryPoint)
                )

                // --- OAuth2 Login
                .oauth2Login(oauth2 -> oauth2
                        .userInfoEndpoint(userInfo -> userInfo
                                .userService(principalDetailsOAuth2Service)
                        )
                        .successHandler(customLoginSuccessHandler())
                )

                // --- Logout
                .logout(l -> l
                        .logoutUrl("/api/user/logout")
                        .addLogoutHandler(logoutHandler())
                        .logoutSuccessHandler(logoutSuccessHandler())
                        .deleteCookies(JwtProperties.ACCESS_TOKEN_COOKIE_NAME, JwtProperties.REFRESH_TOKEN_COOKIE_NAME)
                );

        return http.build();
    }

    /**
     * OAuth2 ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì²˜ë¦¬ í•¸ë“¤ëŸ¬
     * - JWT ìƒì„± ë° ì¿ í‚¤ì— ë‹´ì•„ ë¦¬ë‹¤ì´ë ‰íŠ¸
     */
    @Bean
    public CustomLoginSuccessHandler customLoginSuccessHandler() {
        return (request, response, authentication) -> {
            // 1. JWT ìƒì„±
            TokenInfo tokenInfo = jwtTokenProvider.generateToken(authentication);
            String username = authentication.getName(); // Spring Security UserDetailsì˜ username

            String userid = userRepository.findByUserid(username)
                    .map(user -> user.getUserid())
                    .orElseGet(() -> userRepository.findByEmail(username)
                            .map(user -> user.getUserid())
                            .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."))
                    );

            // 2. Redisì— Refresh Token ì €ì¥ (key: username)
            redisUtil.setData(
                    authentication.getName(),
                    tokenInfo.getRefreshToken(),
                    JwtProperties.REFRESH_TOKEN_EXPIRATION_TIME / 1000);
            // 3. ì¿ í‚¤ ìƒì„± (Access + User)
            ResponseCookie accessCookie = ResponseCookie.from(JwtProperties.ACCESS_TOKEN_COOKIE_NAME, tokenInfo.getAccessToken())
                    .httpOnly(true)
                    .secure(true)
                    .sameSite("None")
                    .path("/")
                    .maxAge(JwtProperties.ACCESS_TOKEN_EXPIRATION_TIME / 1000)
                    .build();

            ResponseCookie userCookie = ResponseCookie.from("userid", authentication.getName())
                    .httpOnly(true)
                    .secure(true)
                    .sameSite("None")
                    .path("/")
                    .maxAge(JwtProperties.REFRESH_TOKEN_EXPIRATION_TIME / 1000)
                    .build();

            // Reactë¡œ usernameê³¼ í•¨ê»˜ ë¦¬ë‹¤ì´ë ‰íŠ¸
            String redirectUrl = allowedOrigins+"/oauth-success?username="
                    + java.net.URLEncoder.encode(username, java.nio.charset.StandardCharsets.UTF_8)
                    + "&userid=" + java.net.URLEncoder.encode(userid, java.nio.charset.StandardCharsets.UTF_8);

            response.addHeader(HttpHeaders.SET_COOKIE, accessCookie.toString());
            response.addHeader(HttpHeaders.SET_COOKIE, userCookie.toString());

            response.sendRedirect(redirectUrl);
        };
    }

    /**
     * ë¡œê·¸ì•„ì›ƒ í•¸ë“¤ëŸ¬
     * - Refresh Token ì‚­ì œ
     */
    @Bean
    public LogoutHandler logoutHandler() {
        return new CustomLogoutHandler(redisUtil, jwtTokenProvider);
    }

    /**
     * ë¡œê·¸ì•„ì›ƒ ì„±ê³µ í•¸ë“¤ëŸ¬
     * - ì„±ê³µ ì‹œ 200 OK ì‘ë‹µ
     */
    @Bean
    public LogoutSuccessHandler logoutSuccessHandler() {
        return new CustomLogoutSuccessHandler();
    }
}

==================== SwaggerConfig.java ====================
package com.example.demo.config;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.Components;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.tags.Tag;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.security.SecurityScheme;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

@Configuration
public class SwaggerConfig {

    private static final String SECURITY_SCHEME_NAME = "bearerAuth";

    @Bean
    public OpenAPI customOpenAPI() {

        return new OpenAPI()
                // ì „ì—­ JWT ë³´ì•ˆ ìë™ ì ìš©
                .addSecurityItem(new SecurityRequirement().addList(SECURITY_SCHEME_NAME))

                // JWT Security Scheme ì •ì˜
                .components(new Components()
                        .addSecuritySchemes(SECURITY_SCHEME_NAME,
                                new SecurityScheme()
                                        .name(SECURITY_SCHEME_NAME)
                                        .type(SecurityScheme.Type.HTTP)
                                        .scheme("bearer")
                                        .bearerFormat("JWT")
                        )
                )

                // UI ì •ë³´
                .info(new Info()
                        .title("Hangle API Documentation")
                        .version("v1.0.0")
                        .description("""
                                **Hangle REST API ë¬¸ì„œ**

                                ğŸ” ì¸ì¦ì´ í•„ìš”í•œ APIëŠ” JWT Bearer ì¸ì¦ì´ ìë™ ì ìš©ë©ë‹ˆë‹¤.  
                                ìƒë‹¨ì˜ Authorize ë²„íŠ¼ìœ¼ë¡œ AccessTokenì„ ì…ë ¥í•˜ì„¸ìš”.

                                ëª¨ë“  ë¬¸ì„œëŠ” ApiDocs.java í•œ íŒŒì¼ì—ì„œë§Œ ê´€ë¦¬ë©ë‹ˆë‹¤.
                                """)
                )

                // TAG ìë™ ë“±ë¡ â†’ Controllerì—ì„œ @Tag ì•ˆ ë¶™ì—¬ë„ ë¨
                .tags(List.of(
                        new Tag().name("User").description("ì‚¬ìš©ì ê³„ì • / ì¸ì¦ / ì„¤ì • API"),
                        new Tag().name("Inquiry").description("1:1 ë¬¸ì˜ API"),
                        new Tag().name("Competition").description("ëŒ€íšŒ API"),
                        new Tag().name("PortOne").description("ë³¸ì¸ ì¸ì¦ API")
                ));
    }
}

==================== TxConfig.java ====================
package com.example.demo.config;

import jakarta.persistence.EntityManagerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import javax.sql.DataSource;

@Configuration
@EnableTransactionManagement
public class TxConfig {
    @Autowired
    private DataSource dataSource;

    //    JPA TransactionManager Settings
    @Bean(name="jpaTransactionManager")
    public JpaTransactionManager jpaTransactionManager(EntityManagerFactory entityManagerFactory) {
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(entityManagerFactory);
        transactionManager.setDataSource(dataSource);

        return transactionManager;
    }

}

==================== WebConfig.java ====================
package com.example.demo.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

import java.nio.file.Path;
import java.nio.file.Paths;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Value("${file.upload-root}")
    private String uploadDir;

    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        // ì„¤ì •ëœ ìƒëŒ€ ê²½ë¡œ(./uploads/)ë¥¼ OSì— ë§ëŠ” ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
        Path path = Paths.get(uploadDir).toAbsolutePath().normalize();

        // íŒŒì¼ ì‹œìŠ¤í…œ URI í˜•ì‹(file:///...)ìœ¼ë¡œ ë³€í™˜
        String uploadPath = path.toUri().toString();

        // /uploads/** ë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ ì‹¤ì œ í´ë”ë¡œ ì—°ê²°
        registry.addResourceHandler("/uploads/**")
                .addResourceLocations(uploadPath);
    }
}

==================== AdminAccountInitializer.java ====================
package com.example.demo.config;

import com.example.demo.domain.user.entity.User;
import com.example.demo.domain.user.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.event.EventListener;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.stereotype.Component;

@Component
public class AdminAccountInitializer {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @EventListener(ApplicationReadyEvent.class)
    public void createDefaultAccounts() {

        createAccountIfNotExists(
                "admin",
                "ê´€ë¦¬ì",
                "ROLE_ADMIN",
                "admin"
        );

        createAccountIfNotExists(
                "manager",
                "ë§¤ë‹ˆì €",
                "ROLE_MANAGER",
                "manager"
        );
    }

    private void createAccountIfNotExists(String userid, String username, String role, String password) {

        if (userRepository.findByUserid(userid) != null) {
            System.out.println("[INIT] ì´ë¯¸ ì¡´ì¬ â†’ " + userid);
            return;
        }

        User user = User.builder()
                .userid(userid)
                .username(username)
                .password(passwordEncoder.encode(password))
                .role(role)
                .isCertified(true)
                .build();

        userRepository.save(user);

        System.out.println("[INIT] ê¸°ë³¸ ê³„ì • ìƒì„± ì™„ë£Œ");
        System.out.println(" â–¶ userid : " + userid);
        System.out.println(" â–¶ password : " + password);
    }
}

==================== CorsConfig.java ====================
package com.example.demo.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig {

    @Value("${cors.allowed-origins}")
    private String allowedOrigins;

    @Bean
    public WebMvcConfigurer webMvcConfigurer() {
        return new WebMvcConfigurer() {
            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/**")
                        .allowedOrigins(allowedOrigins.split(","))
                        .allowedMethods("GET","POST","PUT","DELETE","OPTIONS")
                        .allowedHeaders("*")
                        .allowCredentials(true)
                        .exposedHeaders("Set-Cookie")
                        .maxAge(3600);
            }
        };
    }
}