server {
    listen 443 ssl;
    server_name hangle.store www.hangle.store;

    ssl_certificate     /etc/letsencrypt/live/www.hangle.store/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.hangle.store/privkey.pem;

    root /usr/share/nginx/html;
    index index.html;

    set $backend http://bn-container:8090;

    # --------------------------------------------------------
    # React SPA 라우팅
    # --------------------------------------------------------
    location / {
        try_files $uri $uri/ /index.html;
    }

    # --------------------------------------------------------
    # 정적 파일 캐싱
    # --------------------------------------------------------
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|svg)$ {
        expires 30d;
        access_log off;
    }

    # --------------------------------------------------------
    # 에러 페이지
    # --------------------------------------------------------
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }

    # =======================================================================
    # API Proxy (백엔드 전체) — 모든 /api/** 요청은 이 곳을 거친다
    # =======================================================================
    location /api/ {
        proxy_pass http://bn-container:8090;
        proxy_http_version 1.1;

        # 도메인 유지 (쿠키 작동 핵심)
        proxy_set_header Host $host;

        # IP/Protocol 전달
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        # 쿠키 전달
        proxy_set_header Cookie $http_cookie;
        proxy_set_header Authorization $http_authorization;

        # AI 응답 대기 시간을 10분(600초)로 늘림
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;

        # 백엔드에서 Set-Cookie 내려오는 응답을 프론트로 전달
        proxy_pass_header Set-Cookie;
        proxy_set_header Set-Cookie $http_set_cookie;

        # SameSite=None + Secure 쿠키 재설정
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=None";
    }

    # =======================================================================
    # uploads 경로 프록시 (프로필 이미지, 업로드 파일 모두)
    # =======================================================================
    location /uploads/ {
        # 백엔드로 넘기지 않고, Nginx가 가지고 있는 파일(위에서 마운트한 경로)을 바로 보여줌
        root /usr/share/nginx/html;
        
        # 성능 최적화 (이미지는 캐싱)
        expires 30d;
        access_log off;
        try_files $uri $uri/ =404;

        # 성능 최적화: 무거운 Spring Boot를 통하지 않기 때문에 이미지 로딩 속도가 훨씬 빠릅니다.
        # 안정성: 백엔드 서버가 점검 중이거나 재시작 중이어도 이미지는 정상적으로 보입니다.
        # 유지보수: 파일 경로 문제로 Java 코드를 수정하고 다시 오래 걸리는 빌드를 할 필요가 없습니다.
        # Ctrl + Shift + R (강력 새로고침)
    }

    # =======================================================================
    # 로그인 (프록시 일치 유지)
    # =======================================================================
    location /api/user/login {
        proxy_pass http://bn-container:8090/login;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header Authorization $http_authorization;

        proxy_pass_header Set-Cookie;
        proxy_set_header Set-Cookie $http_set_cookie;

        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=None";
    }

    # =======================================================================
    # PortOne 인증 요청
    # =======================================================================
    location /portOne/ {
        proxy_pass http://bn-container:8090;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        proxy_set_header Cookie $http_cookie;
        proxy_set_header Authorization $http_authorization;
        proxy_pass_header Set-Cookie;
        proxy_set_header Set-Cookie $http_set_cookie;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=None";
    }

    # =======================================================================
    # 로그아웃 (LogoutHandler + SPA logout 모두 정상 작동)
    # =======================================================================
    location /logout {
        proxy_pass http://bn-container:8090/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header Authorization $http_authorization;

        proxy_pass_header Set-Cookie;
        proxy_set_header Set-Cookie $http_set_cookie;

        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=None";
    }

    # =======================================================================
    # OAuth2 Redirect
    # =======================================================================
    location /oauth2/ {
        proxy_pass http://bn-container:8090/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header Authorization $http_authorization;

        proxy_pass_header Set-Cookie;
        proxy_set_header Set-Cookie $http_set_cookie;

        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=None";
    }

    # =======================================================================
    # [필수 추가] OAuth2 로그인 후 돌아오는 경로 (Callback)
    # =======================================================================
    location /login/oauth2/ {
        proxy_pass http://bn-container:8090;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        # 쿠키 및 헤더 전달
        proxy_set_header Cookie $http_cookie;
        proxy_set_header Authorization $http_authorization;
        proxy_pass_header Set-Cookie;
        proxy_set_header Set-Cookie $http_set_cookie;
        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=None";
    }

    # =======================================================================
    # Join (필요하면 유지, 쿠키 전달 추가)
    # =======================================================================
    location /join {
        proxy_pass http://bn-container:8090;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header Authorization $http_authorization;

        proxy_pass_header Set-Cookie;
        proxy_set_header Set-Cookie $http_set_cookie;

        proxy_cookie_path / "/; Secure; HttpOnly; SameSite=None";
    }
}
