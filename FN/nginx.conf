worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    sendfile on;
    keepalive_timeout 65;

    # ----------------------------------------------------
    # 1. HTTP (80ë²ˆ í¬íŠ¸) ì„œë²„: HTTPSë¡œ ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì„¤ì •
    # ----------------------------------------------------
    server {
        listen 80;
        server_name www.hangle.store hangle.store; # ì‹¤ì œ ë„ë©”ì¸ëª…ìœ¼ë¡œ ë³€ê²½
        
        # 80ë²ˆ í¬íŠ¸ë¡œ ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  ìš”ì²­ì„ 443ë²ˆ(HTTPS)ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        return 301 https://$host$request_uri;
    }
    
    # ----------------------------------------------------
    # 2. HTTPS (443ë²ˆ í¬íŠ¸) ì„œë²„: ì‹¤ì œ ì„œë¹„ìŠ¤ ì²˜ë¦¬
    # ----------------------------------------------------
    server {
        listen 443 ssl;
        server_name www.hangle.store hangle.store;

        ssl_certificate /etc/letsencrypt/live/www.hangle.store/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/www.hangle.store/privkey.pem;

        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:10m;
        ssl_session_tickets off;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        # ----------------------------------------------
        # ğŸ”¥ [ì¤‘ìš”] ë°±ì—”ë“œë¡œ í”„ë¡ì‹œí•´ì•¼ í•˜ëŠ” ëª¨ë“  ê²½ë¡œ
        # ----------------------------------------------

        # ê¸°ë³¸ ë¡œê·¸ì¸
        location /login {
            proxy_pass http://bn:8090;
            include proxy_params;
        }

        # íšŒì›ê°€ì…
        location /join {
            proxy_pass http://bn:8090;
            include proxy_params;
        }

        # í† í° ê²€ì¦
        location /validate {
            proxy_pass http://bn:8090;
            include proxy_params;
        }

        # ë¡œê·¸ì•„ì›ƒ
        location /logout {
            proxy_pass http://bn:8090;
            include proxy_params;
        }

        # OAuth2 ì†Œì…œ ë¡œê·¸ì¸
        location /oauth2/ {
            proxy_pass http://bn:8090;
            include proxy_params;
        }

        # API ì „ì²´
        location /api/ {
            proxy_pass http://bn:8090;
            include proxy_params;
        }

        # ----------------------------------------------
        # React ì •ì  íŒŒì¼ ë° SPA ë¼ìš°íŒ…
        # ----------------------------------------------
        location / {
            root   /usr/share/nginx/html;
            index  index.html;
            try_files $uri $uri/ /index.html;
        }

        # ì •ì  íŒŒì¼ ìºì‹±
        location ~* \.(css|js|jpg|jpeg|png|gif|ico|woff|woff2|ttf|eot|svg)$ {
            root /usr/share/nginx/html;
            expires 30d;
            access_log off;
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root  /usr/share/nginx/html;
        }
    }

    # ê³µí†µ í”„ë¡ì‹œ ì„¤ì • ëª¨ë“ˆ (í¸ì˜ë¥¼ ìœ„í•´ ì¶”ê°€)
    # íŒŒì¼ ì•„ë˜ìª½ì— ì¶”ê°€í•´ë„ ë˜ê³  /etc/nginx/proxy_params ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì‚¬ìš© ê°€ëŠ¥
    map "" $proxy_params {
        default "";
    }
}