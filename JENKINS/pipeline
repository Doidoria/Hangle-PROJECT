pipeline {
    agent any
    
    environment {
        GITHUB_REPO = 'https://github.com/Doidoria/Hangle-PROJECT.git'
        EC2_HOST = '52.78.83.206'
        EC2_USER = 'ec2-user'
    }
    
    stages {
        stage('Clone and Deploy on EC2') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {

                    sh """
chmod 600 ${SSH_KEY}

ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'

cd ~

if [ -d Hangle-PROJECT ]; then
    echo "[INFO] 기존 프로젝트 발견 → git pull"
    cd Hangle-PROJECT
    git reset --hard
    git pull
else
    echo "[INFO] 프로젝트가 없어 git clone 수행"
    git clone ${GITHUB_REPO}
    cd Hangle-PROJECT
fi

echo "[INFO] Docker 정리"
sudo docker-compose down || true
sudo docker container prune -f || true
sudo docker image prune -af || true

echo "[INFO] Docker 이미지 다시 빌드"
sudo docker-compose build --no-cache

echo "[INFO] Docker 컨테이너 재시작"
sudo docker-compose up -d

EOF
"""
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment to EC2 completed successfully![O]'
        }
        failure {
            echo 'Deployment to EC2 failed![X]'
        }
    }
}
