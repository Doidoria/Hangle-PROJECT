pipeline {
    agent any
    
    environment {
        GITHUB_REPO = 'https://github.com/Doidoria/Hangle-PROJECT.git'
        EC2_HOST = 'www.hangle.store'
        EC2_USER = 'ec2-user'
        // 브랜치 이름이 main임을 확정합니다.
        GIT_BRANCH = 'main' 
        // 프로젝트 디렉토리 변수를 환경 블록에 추가
        PROJECT_DIR = 'Hangle-PROJECT' 
    }
    
    stages {
        stage('Clone and Deploy on EC2') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {

                    // 1. SSH 키 권한 설정
                    sh "chmod 600 ${SSH_KEY}"

                    // 2. SSH 접속 (EC2 서버에서 실행)
                    sh """
                        ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} '
                            # SSH 세션 내부의 쉘 명령 시작
                            set -e # 에러 발생 시 즉시 종료 (안전장치)

                            # 쉘 변수 정의: Jenkins 환경 변수 값을 작은 따옴표로 감싸 안전하게 주입
                            BRANCH_NAME="${GIT_BRANCH}"
                            PROJECT_DIR_VAR="${PROJECT_DIR}"
                            REPO_URL="${GITHUB_REPO}"

                            echo "--- SSH 세션 시작 ---"

                            # 1. 프로젝트 폴더로 이동 또는 클론
                            cd ~

                            # 원격 쉘 변수 사용 시: \$PROJECT_DIR_VAR
                            if [ -d \$PROJECT_DIR_VAR ]; then
                                echo "[FIX] Setting ownership to ec2-user to fix Git permissions"
                                # ec2-user에게 프로젝트 폴더 소유권을 부여하여 "Permission denied" 에러 해결
                                sudo chown -R ec2-user:ec2-user \$PROJECT_DIR_VAR

                                echo "[INFO] 기존 프로젝트 발견 → 강제 업데이트"
                                cd \$PROJECT_DIR_VAR
                                
                                # Git Ownership 경고 해결 (필수)
                                git config --global --add safe.directory /home/ec2-user/\$PROJECT_DIR_VAR

                                # Git 상태 초기화 및 최신 코드 강제 가져오기
                                git fetch origin \$BRANCH_NAME
                                
                                # Git 리셋 (브랜치 변수 사용)
                                git reset --hard origin/\$BRANCH_NAME
                                
                                # 혹시 모를 로컬 파일까지 완전 삭제
                                git clean -fd

                            else
                                echo "[INFO] 프로젝트가 없어 git clone 수행"
                                git clone \$REPO_URL
                                cd \$PROJECT_DIR_VAR
                            fi

                            echo "[INFO] Docker 정리 및 캐시 초기화"
                            # 기존 컨테이너 중지 및 제거 (성공/실패 여부와 관계없이)
                            sudo docker-compose down || true

                            # 모든 Docker 캐시 및 잔여물 완전 삭제
                            sudo docker container prune -f || true
                            sudo docker image prune -af || true


                            echo "[INFO] Docker 이미지 다시 빌드 (no-cache 적용)"
                            # --no-cache를 사용하여 이전 빌드 실패 레이어 무시 및 재빌드 강제
                            sudo docker-compose build --no-cache

                            echo "[INFO] Docker 컨테이너 재시작"
                            sudo docker-compose up -d

                            echo "--- SSH 세션 종료 ---"
                        '
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment to EC2 completed successfully![O]'
        }
        failure {
            echo 'Deployment to EC2 failed![X]'
        }
    }
}