pipeline {
    agent any
    
    environment {
        GITHUB_REPO = 'https://github.com/Doidoria/Hangle-PROJECT.git'
        EC2_HOST = 'www.hangle.store'
        EC2_USER = 'ec2-user'
        // 브랜치 이름이 main임을 확정합니다.
        GIT_BRANCH = 'main' 
        // 프로젝트 디렉토리 변수를 환경 블록에 추가
        PROJECT_DIR = 'Hangle-PROJECT' 
    }
    
    stages {
        stage('Clone and Deploy on EC2') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {

                    // 1. SSH 키 권한 설정
                    sh "chmod 600 ${SSH_KEY}"

                    // 2. SSH 접속 (EC2 서버에서 실행)
                    sh """
ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << "EOF"
    set -e
    BRANCH_NAME="${GIT_BRANCH}"
    PROJECT_DIR_VAR="${PROJECT_DIR}"
    REPO_URL="${GITHUB_REPO}"

    cd ~

    if [ -d $PROJECT_DIR_VAR ]; then
        sudo chown -R ec2-user:ec2-user $PROJECT_DIR_VAR
        cd $PROJECT_DIR_VAR
        git config --global --add safe.directory \$HOME/$PROJECT_DIR_VAR
        git fetch origin $BRANCH_NAME
        git reset --hard origin/$BRANCH_NAME
        git clean -fd
    else
        git clone $REPO_URL
        cd $PROJECT_DIR_VAR
    fi

    docker-compose down || true
    docker container prune -f || true
    docker image prune -f || true
    docker-compose build --no-cache
    docker-compose up -d
EOF
"""
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment to EC2 completed successfully![O]'
        }
        failure {
            echo 'Deployment to EC2 failed![X]'
        }
    }
}